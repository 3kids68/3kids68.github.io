<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Sampling Plan Analyzer</title>
    
    <!-- 引入 Chart.js, jStat.js 和 chartjs-plugin-annotation -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jstat@latest/dist/jstat.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0"></script>

    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');

        /* ===== 主背景區（全頁背景） ===== */
        :root {
            --bg-gradient-start: #05131c;
            --bg-gradient-end: #3d4e5f;
            --container-bg: rgba(33, 49, 63, 0.92); /* #21313f */
            --text-color: #c7cacf;
            --primary-color: #647281;
            --secondary-color: #a3aab3;
            --input-bg: rgba(61, 78, 95, 0.18); /* #3d4e5f */
            --input-border: #a3aab3;
            --shadow-color: rgba(5, 19, 28, 0.45);
            --plan-btn-bg: rgba(100, 114, 129, 0.18); /* #647281 */
            --plan-btn-bg-hover: rgba(100, 114, 129, 0.38);
        }

        body, button, input, select, textarea {
          font-family:
            'Helvetica Neue', 'Noto Sans TC', 'PingFang TC', 'Microsoft JhengHei', '微軟正黑體',
            'Heiti TC', '黑體-繁', 'Arial', 'Inter', Helvetica, sans-serif;
        }

        body {
            background: linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-end));
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        /* ===== 主卡片區（外層 main-container） ===== */
        .main-container {
            background: var(--container-bg);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px var(--shadow-color);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid #647281;
        }

        header {
            text-align: center;
            margin-bottom: 20px;
        }

        header h1 {
            font-size: 2.5em;
            font-weight: 700;
            text-shadow: 2px 2px 5px var(--shadow-color);
            margin: 0;
        }
        
        header p {
            font-size: 1.1em;
            color: rgba(255, 255, 255, 0.8);
            min-height: 1.2em; /* 避免切換時跳動 */
        }
        
        .mode-selector {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
            padding: 8px;
            flex-wrap: wrap; /* 允許換行 */
        }
        .mode-selector label {
            flex: 1;
            padding: 10px 20px;
            text-align: center;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-weight: 500;
            min-width: 150px; /* 確保標籤有足夠寬度 */
        }
        .mode-selector input {
            display: none;
        }
        .mode-selector input:checked + label {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 4px 10px rgba(52, 152, 219, 0.4);
        }


        .content-wrapper {
            display: flex;
            align-items: stretch;
            height: 650px; /* 或與 .chart-container 一致 */
        }

        .controls-and-plans {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 340px;
            padding: 0;
            height: 100%;
        }
        #distribution-controls,
        #plan-controls,
        .panel,
        #plan-controls > .panel,
        #plan-controls > .panel.controls-panel,
        #plan-controls > .panel.plan-list-container {
            width: 100% !important;
            box-sizing: border-box;
            margin: 0;
        }

        .panel {
            width: 340px;
            box-sizing: border-box;
            background: rgba(61, 78, 95, 0.22); /* #3d4e5f */
            padding: 20px;
            border-radius: 15px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }

        .panel h3 {
            margin-top: 0;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 4px;
            font-size: 1.4em;
        }
        
        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .input-group { display: flex; flex-direction: column; }
        .input-group label { margin-bottom: 5px; font-size: 0.9em; font-weight: 500; text-align: center; }
        .input-group input, .input-group select {
            background: var(--input-bg); border: 1px solid var(--input-border);
            border-radius: 8px; padding: 10px; color: var(--text-color);
            font-size: 1em; transition: all 0.3s ease; text-align: center;
        }
        .input-group input:focus, .input-group select:focus {
            outline: none; border-color: var(--primary-color);
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.5);
        }
        /* 讓下拉選單的文字靠左 */
        .input-group select {
             text-align: left;
             text-align-last: left;
        }
        /* Sampling Standard 檢查類型按鈕列：若寬度不足自動縮小按鈕 */
        .inspection-type-row {
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: nowrap;
        }
        .inspection-type-row .inspection-type-btn {
            max-width: 126px;
            white-space: nowrap;
        }
        @media (max-width: 1100px) {
            .inspection-type-row .inspection-type-btn { max-width: 108px; padding: 8px 12px; font-size: 0.95em; }
        }
        @media (max-width: 980px) {
            .inspection-type-row .inspection-type-btn { max-width: 90px; padding: 8px 10px; font-size: 0.9em; }
        }
        @media (max-width: 860px) {
            .inspection-type-row { flex-wrap: wrap; }
            .inspection-type-row .inspection-type-btn { flex: 1 1 30%; max-width: none; min-width: 90px; }
        }
        
        /* ▲▲▲▲▲ 修正後的 CSS ▲▲▲▲▲ */
        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center; /* 讓按鈕群組水平置中 */
        }

        /* 基礎按鈕樣式 (只給最基本的) */
        button {
            cursor: pointer;
            border: none;
            color: #c7cacf;
            font-family: 'Noto Sans TC', sans-serif;
            font-weight: 700;
            padding: 10px 20px;
            transition: all 0.2s ease;
        }

        /* 建立一個通用的 3D 風格按鈕類 */
        /* [所有頁面] 3D 風格主要按鈕（如 Sampling Plan Theory, Add Plan 等） */
        .btn-styled {
            border-radius: 8px;
            border: 1.5px solid #647281;
            background: linear-gradient(180deg, rgba(100,114,129,0.85) 0%, rgba(100,114,129,0.56) 100%);
            box-shadow: 0 2px 8px rgba(100,114,129,0.5), 0 6px 24px rgba(33, 49, 63, 0.18);
            position: relative;
            overflow: hidden;
            letter-spacing: 1px;
        }
        .btn-styled:hover {
            box-shadow: 0 6px 24px rgba(100,114,129,0.85), 0 12px 36px rgba(33, 49, 63, 0.5);
            transform: translateY(-2px) scale(1.04);
            background: linear-gradient(180deg, rgba(100,114,129,1) 0%, rgba(100,114,129,0.7) 100%);
        }
        .btn-styled:active {
            box-shadow: 0 1px 2px rgba(100,114,129,0.85);
            transform: translateY(1px) scale(0.98);
            background: linear-gradient(180deg, rgba(100,114,129,0.65) 0%, rgba(100,114,129,0.85) 100%);
        }
        .btn-styled::after {
            content: "";
            position: absolute;
            left: 0; top: 0; right: 0; height: 40%;
            background: linear-gradient(180deg, rgba(255,255,255,0.10) 0%, rgba(255,255,255,0.01) 100%);
            pointer-events: none;
        }
        .btn-styled:disabled {
            background: #a3aab3 !important;
            color: #eee !important;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        /* [多計畫比較頁面] 新增計畫按鈕（Add Plan） */
        .btn-add { background: rgba(39,174,96,0.5); } /* 綠色 */
        .btn-add:hover { background: rgba(39,174,96,0.9); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4); }
        /* [多計畫比較頁面] 清除全部按鈕（Clear All） */
        .btn-clear { background: rgba(231,76,60,0.5); } /* 紅色 */
        .btn-clear:hover { background: rgba(231,76,60,0.9); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4); }

        .panel.plan-merged-panel {
            display: flex;
            flex-direction: column;
            height: 100%;
            box-sizing: border-box;
        }
        .plan-list {
            flex: 1 1 0%;
            max-height: unset;
            overflow-y: auto;
            padding-left: 0;
            margin-bottom: 0;
        }
        
        .plan-list::-webkit-scrollbar { width: 8px; }
        .plan-list::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); border-radius: 4px; }
        .plan-list::-webkit-scrollbar-thumb { background: var(--primary-color); border-radius: 4px; }

        .plan-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px; margin-bottom: 10px; border-radius: 8px;
            background: rgba(255,255,255,0.05); border-left: 5px solid;
            transition: background 0.3s ease; width: 100%; box-sizing: border-box;
            font-size: 14px;
        }
        .plan-item:hover { background: rgba(255,255,255,0.1); }
        /* [多計畫比較頁面] 刪除單一計畫按鈕（動態產生，class="delete-btn"） */
        .delete-btn {
            background: #e74c3c; /* 使用一個更明顯的紅色 */
            border-radius: 50%; /* 圓形按鈕 */
            width: 22px;
            height: 22px;
            font-size: 14px;
            font-weight: bold;
            line-height: 22px; /* 垂直居中 '×' */
            text-align: center;
            padding: 0;
            margin-left: 10px;
            flex-grow: 0; /* 覆蓋 button 的 flex-grow */
            text-transform: none; /* 覆蓋 button 的 text-transform */
        }
        .delete-btn:hover { background: #c0392b; transform: scale(1.1); }

        .chart-container {
            flex: 2;
            height: 650px;
            padding: 24px;
            background: #05131c;
            border-radius: 15px;
        }
        
        .distribution-options {
            margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        .distribution-options label {
            display: block; margin-bottom: 8px; font-size: 1em;
            font-weight: 500; cursor: pointer;
        }
        .distribution-options input[type="checkbox"] {
            margin-right: 8px; -webkit-appearance: none; -moz-appearance: none;
            appearance: none; width: 18px; height: 18px; border: 2px solid var(--primary-color);
            border-radius: 4px; vertical-align: middle; position: relative;
            cursor: pointer; outline: none; background-color: var(--input-bg);
            transition: all 0.2s ease;
        }
        .distribution-options input[type="checkbox"]:checked {
            background-color: var(--primary-color); border-color: var(--primary-color);
        }
        .distribution-options input[type="checkbox"]:checked::before {
            content: '✔'; display: block; position: absolute; top: 50%;
            left: 50%; transform: translate(-50%, -50%); font-size: 14px; color: white;
        }

        footer {
            text-align: center; margin-top: 30px;
            color: rgba(255, 255, 255, 0.6); font-size: 0.9em;
        }

        #plan-controls .input-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        #plan-controls .input-group input {
            width: 100%;
            max-width: 140px;
            min-width: 0;
            box-sizing: border-box;
            margin: 0 auto;
        }
        #plan-controls .input-group {
            align-items: center;
        }
        .content-wrapper {
            display: flex;
            gap: 30px;
            align-items: stretch;
            height: 700px; /* 可調整與 .chart-container 高度一致 */
        }
        .controls-and-plans {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 340px;
            padding: 0;
            height: 100%; /* 填滿父層高度 */
        }
        #plan-controls {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .panel.plan-merged-panel {
            display: flex;
            flex-direction: column;
            height: 100%;
            box-sizing: border-box;
        }
        .plan-list {
            flex: 1 1 0%;
            max-height: unset;
            overflow-y: auto;
            padding-left: 0;
        }

        .input-group select {
            min-width: 120px;
            width: 100%;
            max-width: 220px;
            padding: 8px 10px;
            border-radius: 8px;
            background: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--input-border);
            font-size: 1em;
            margin-bottom: 2px;
        }

        /* 逆向查詢按鈕主色強化 */
        #reverse-math-controls .btn-primary {
            background: rgba(23,131,255,0.8);
            color: #fff;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(23,131,255,0.30);
            transition: background 0.2s, box-shadow 0.2s;
        }
        #reverse-math-controls .btn-primary:hover {
            background: rgba(23,131,255,0.38);
            box-shadow: 0 4px 16px rgba(23,131,255,0.18);
        }
        .reverse-select-btn {
            background: var(--plan-btn-bg, rgba(10, 15, 87, 0.8));
            color: #fff;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            padding: 5px 18px;
            margin-right: 8px;
            font-size: 1em;
            cursor: pointer;
            box-shadow: 0 2px 8px var(--plan-btn-bg, rgba(23,131,255,0.5));
            transition: background 0.2s, box-shadow 0.2s, transform 0.1s;
            text-shadow: 0 1px 2px rgba(0,0,0,0.28);
            border-bottom: 3px solid rgba(0,0,0,0.12);
            outline: none;
        }
        .reverse-select-btn:hover, .reverse-select-btn.highlighted {
            background: var(--plan-btn-bg-hover, rgba(10,15,87,0.55));
            box-shadow: 0 4px 16px var(--plan-btn-bg-hover, rgba(23,131,255,0.28));
            transform: translateY(-2px) scale(1.04);
            color: #FFD700;
        }
        .blink {
            animation: blink-anim 1s steps(2, start) infinite;
        }
        @keyframes blink-anim {
            to { visibility: hidden; }
        }

        .panel.plan-list-container h3 {
            margin-bottom: 0;
            padding-bottom: 4px;
        }
        .plan-list {
            padding-top: 4px;
            margin-top: 2px;
            margin-bottom: 0;
        }

        .kaiyi-images {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
        }
        .kaiyi-img {
            max-width: 95%;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            border: 1px solid #ccc;
        }
        
        .main-row {
            display: flex;
            align-items: stretch;
        }

        /* 統一主要按鈕樣式 */
        /* [分配比較頁面/多計畫比較頁面/圖表區等] 主要操作按鈕（如 Export PNG, Export Data, Sampling Plan Theory） */
        .main-btn, .btn-primary {
            background: rgba(100,114,129,0.5);
            color: #c7cacf;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(100,114,129,0.30);
            transition: background 0.2s, box-shadow 0.2s;
            letter-spacing: 1px;
            padding: 8px 22px;
            font-size: 1em;
            cursor: pointer;
        }
        .main-btn:hover, .btn-primary:hover {
            background: rgba(163,170,179,0.38);
            box-shadow: 0 4px 16px rgba(100,114,129,0.5);
        }
        .main-btn:disabled, .btn-primary:disabled {
            background: #a3aab3;
            color: #eee;
            cursor: not-allowed;
        }
        #kaiyi-prev-btn, #kaiyi-next-btn {
            all: unset;
        }
        #kaiyi-prev-btn.main-btn, #kaiyi-next-btn.main-btn {
            all: unset;
            background: rgba(23,131,255,0.5); color: #fff; font-weight: bold;
            border: none; border-radius: 8px; box-shadow: 0 2px 8px rgba(23,131,255,0.30);
            transition: background 0.2s, box-shadow 0.2s; letter-spacing: 1px;
            padding: 8px 22px; font-size: 1em; cursor: pointer;
        }
        #kaiyi-prev-btn.main-btn:hover, #kaiyi-next-btn.main-btn:hover {
            background: rgba(23,131,255,0.5); box-shadow: 0 4px 16px rgba(23,131,255,0.3);
        }
        #kaiyi-prev-btn.main-btn:disabled, #kaiyi-next-btn.main-btn:disabled {
            background: #b0c4de; color: #eee; cursor: not-allowed;
        }
        .export-btn-group {
            display: flex; gap: 12px; margin-bottom: 12px;
        }
        .export-btn-group button {
             padding: 8px 18px; flex-grow: 0;
        }
        .btn-add, .btn-clear {
            min-width: 110px;
            padding: 0; /* 取消上下 padding，避免影響置中 */
            font-size: 1.08em;
            height: 42px;
            line-height: 42px; /* 讓文字垂直置中 */
            text-align: center;
        }
    </style>
    <style>
    /* Sampling Standard 下拉欄底色沿用 C=0 頁面的配色 */
    #sampling-standard-controls .input-group select option {
        background: #25364a;
        color: #fff;
    }
    #sampling-standard-controls .input-group select optgroup {
        background: #1a2636;
        color: #FFD700;
        font-weight: bold;
        font-size: 1.05em;
    }
    /* 置中 Sampling Standard 的下拉欄位 */
    #sampling-standard-controls .input-grid { justify-items: center; }
    #sampling-standard-controls .input-group { align-items: center; }
    #sampling-standard-controls .input-group select { margin: 0 auto; }
    /* 讓AQL查表工具的下拉選單區塊與選單內容置中 */
    #aql-lookup-tool .query-controls {
        display: flex !important;
        flex-direction: column !important;
        align-items: stretch !important;
        gap: 20px !important;
    }
    #aql-lookup-tool .input-group {
        width: 100%;
        align-items: stretch;
    }
    #aql-lookup-tool .input-group select {
        text-align: center;
        text-align-last: center;
        width: 100%;
    }
    #aql-lookup-tool .input-group label {
        text-align: left;
        margin-bottom: 8px;
    }

    /* AQL查表工具下拉選單區塊的外層背景色 */
    #aql-lookup-tool .main-container {
        background: rgba(44, 62, 80, 0.6) !important;
    }
    /* 只對 Firefox 有效：AQL查表工具下拉選單展開時選項的背景色 */
    #aql-lookup-tool .input-group select option {
        background: #25364a;
        color: #fff;
    }
    /* 只對 Firefox 有效：AQL查表工具下拉選單 optgroup 標題的背景色與字色 */
    #aql-lookup-tool .input-group select optgroup {
        background: #1a2636;   /* 你想要的深色，可自行調整 */
        color: #FFD700;        /* 文字顏色，建議亮色 */
        font-weight: bold;
        font-size: 1.05em;
        /* Firefox 專屬，其他瀏覽器不會有影響 */
    }
    /* C=0抽樣計畫下拉選單選項的背景色 */
    #c0-plan-controls .input-group select option {
        background: #25364a;
        color: #fff;
    }
    /* C=0抽樣計畫下拉選單 optgroup 標題的背景色與字色 */
    #c0-plan-controls .input-group select optgroup {
        background: #1a2636;
        color: #FFD700;
        font-weight: bold;
        font-size: 1.05em;
    }
    </style>
    <style>
    /* 抽樣計畫原理說明彈窗樣式 */
    #sampling-theory-modal-bg {
        display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100vw; height: 100vh;
        background: rgba(30,40,60,0.65); 
        backdrop-filter: blur(2px);
        -webkit-backdrop-filter: blur(2px);
        justify-content: flex-start; align-items: center;
    }
    #sampling-theory-modal {
        background: #1a2636; color: #fff; max-width: 1200px; width: 92vw; max-height: 80vh;
        border-radius: 18px; box-shadow: 0 8px 32px rgba(0,0,0,0.35);
        padding: 32px 0 24px 0; /* 左右 padding 改為 0，確保內容橫向中心 */
        position: relative; overflow-y: auto;
        font-size: 1.08em; line-height: 1.7;
        display: flex; flex-direction: column; align-items: center; /* 讓內容橫向置中 */
        margin-left: 20px; /* 讓彈窗本體靠左，與控制面板對齊 */
    }
    #sampling-theory-modal h2 {
        font-size: 1.35em; margin-top: 0; margin-bottom: 18px; color: #FFD700;
        text-align: center;
    }
    #sampling-theory-modal .close-btn {
        position: absolute; top: 14px; right: 18px; background: none; border: none;
        color: #FFD700; font-size: 1.6em; font-weight: bold; cursor: pointer;
        transition: color 0.2s;
    }
    #sampling-theory-modal .close-btn:hover { color: #ff7675; }
    #sampling-theory-modal::-webkit-scrollbar { width: 8px; }
    #sampling-theory-modal::-webkit-scrollbar-thumb { background: #fff; border-radius: 4px; }
    /* 讓說明內容置中 */
    #sampling-theory-modal > div[style] {
        text-align: left;
        margin: 0;
        max-width: 100%;
        line-height: 1.8;
        padding: 0 0 0 18px; /* 左側 18px，右側 0，讓內容更靠左 */
        box-sizing: border-box;
    }
    </style>
    <style>
    /* Inspection Type 橫向按鈕組 */
    .inspection-type-group {
        display: flex;
        flex-direction: row;
        gap: 16px;
        justify-content: center;
        align-items: center;
        margin-bottom: 12px;
    }
    .inspection-type-btn {
        background: rgba(23,131,255,0.18);
        color: #fff;
        font-weight: bold;
        border: 2px solid #1783FF;
        border-radius: 8px;
        min-width: 110px;
        padding: 7px 0;
        font-size: 1em;
        cursor: pointer;
        transition: background 0.18s, color 0.18s, border 0.18s, box-shadow 0.18s;
        outline: none;
        box-shadow: 0 2px 8px rgba(23,131,255,0.10);
    }
    .inspection-type-btn.active, .inspection-type-btn:focus {
        background: #073a74;
        color: #fff;
        border-color: #073a74;
        box-shadow: 0 4px 16px rgba(23,131,255,0.18);
    }
    .inspection-type-btn:hover {
        background: rgba(23,131,255,0.38);
        color: #FFD700;
    }
    </style>
    <style>
    /* ===== 查詢結果區（Query Result） ===== */
    #result-container {
        background: transparent;
        border: 3px solid #647281;
        border-radius: 20px;
        padding: 0;
        margin: 0;
        box-shadow: none;
    }

    #result-container > div {
        background: transparent;
        border-radius: 17px;
        padding: 25px;
    }
    </style>
    <style>
    /* 在 style 區塊新增： */
    #sampling-theory-modal h2.concept-title { color: #4ECDC4; }  /* 青綠 */
    #sampling-theory-modal h2.risk-title { color: #F0884D; }     /* 橘黃 */
    #sampling-theory-modal h2.math-title { color: #A3AAB3; }     /* 淺灰藍 */
    </style>
    <style>
    /* 新增 h3 子標題顏色設定 */
    #sampling-theory-modal h3.concept-subtitle { color: #2491B3; }  /* 深青藍 */
    #sampling-theory-modal h3.risk-subtitle { color: #BD8F24; }     /* 深橘黃 */
    #sampling-theory-modal h3.math-subtitle { color: #647281; }     /* 深灰藍 */
    </style>
    <style>
    /* 移除：C=0抽樣表圖片彈窗樣式（按鈕與彈窗已刪） */
    </style>
</head>
<body>
    <!-- Password Unlock Mask -->
    <!-- [已徹底移除密碼與到期日相關區塊] -->
    <div class="main-container">
        <header>
            <h1 id="header-title"></h1>
            <p id="header-subtitle"></p>
        </header>

        <div class="mode-selector">
            <input type="radio" name="mode" id="mode-distribution" value="distribution" checked>
            <label for="mode-distribution">Probability Distribution Comparison</label>
            <input type="radio" name="mode" id="mode-plan" value="plan">
            <label for="mode-plan">Multiple Plan Comparison</label>
            <input type="radio" name="mode" id="mode-reverse" value="reverse">
            <label for="mode-reverse">Reverse Sampling Query</label>
            <input type="radio" name="mode" id="mode-kaiyi" value="kaiyi">
            <label for="mode-kaiyi">AQL Plan Table Lookup</label>
            <!-- [新增] C=0 抽樣計畫選項 -->
            <input type="radio" name="mode" id="mode-c0" value="c0_plan">
            <label for="mode-c0">C=0 Plan Table Lookup</label>
        </div>
        
        <div class="content-wrapper">
            <div class="controls-and-plans">
                <div id="distribution-controls" class="panel">
                    <h3>Control Panel</h3>
                    <div class="input-grid">
                        <div class="input-group">
                            <label for="dist_lot_size_input">Lot Size (N)</label>
                            <input type="number" id="dist_lot_size_input" value="500" min="1">
                        </div>
                        <div class="input-group">
                            <label for="dist_n_input">Sample Size (n)</label>
                            <input type="number" id="dist_n_input" value="100" min="1">
                        </div>
                        <div class="input-group">
                            <label for="dist_c_input">Acceptance No. (c)</label>
                            <input type="number" id="dist_c_input" value="1" min="0">
                        </div>
                    </div>
                    <div class="distribution-options">
                        <h4>Show Distribution Curves:</h4>
                        <label><input type="checkbox" id="show-hypergeometric" checked> Hypergeometric (Accurate, Complex Calculation)</label>
                        <label><input type="checkbox" id="show-binomial"> Binomial (Approximate, for Large Lots)</label>
                        <label><input type="checkbox" id="show-poisson" checked> Poisson (Approximate, for Infinite Lot & Low Defect Rate)</label>
                    </div>
                    <div id="dist-error-msg" style="color:#ff7675; min-height:1.5em; margin-top:8px; text-align:center;"></div>
                    <!-- 抽樣計畫原理說明按鈕 -->
                    <div style="text-align:center; margin-top:16px;">
                        <!-- [分配比較頁面] 「Sampling Plan Theory」說明彈窗按鈕 -->
                        <button id="sampling-theory-btn" class="main-btn btn-styled" type="button">Sampling Plan Theory</button>
                        <!-- /[分配比較頁面] -->
                    </div>
                </div>

                <!-- [新增] C=0 抽樣計畫控制面板 -->
                <div id="c0-plan-controls" class="panel" style="display:none;">
                    <h3>C=0 Sampling Plan Lookup</h3>
                    <div style="background: rgba(255,193,7,0.15); padding: 10px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #ffc107;">
                        <small style="color: #ffc107; font-weight: bold;">ℹ️ Note:</small>
                        <small style="color: #c7cacf; line-height: 1.4;">C=0 plans use Nicholas L. Squeglia's specialized standard, which may differ from ANSI/ASQ Z1.4 c=0 plans due to different design philosophies and risk assessment approaches.</small>
                    </div>
                    <div class="input-grid" style="grid-template-columns: 1fr;">
                        <div class="input-group">
                            <label for="c0_lot_size_select">Lot Size Range</label>
                            <select id="c0_lot_size_select" style="text-align:center; text-align-last:center; margin:auto;"></select>
                        </div>
                        <div class="input-group" style="align-items:center;">
                            <label for="c0_n_select">Sample Size (n)</label>
                            <select id="c0_n_select" style="text-align:center; text-align-last:center; margin:auto;"></select>
                        </div>
                    </div>
                    <div id="c0-result" style="margin-top: 20px; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 8px; text-align: center; font-size: 1.2em; font-weight: bold; min-height: 2em;"></div>
                    <div id="c0-lq-info" style="margin-top: 8px; color: #a15511; text-align: center; font-size: 1.1em;"></div>
                    <div id="c0-error" style="color: #af2432; margin-top: 10px; text-align: center;"></div>
                    <!-- 新增：匯出至多計畫比較按鈕 -->
                    <div style="text-align:center; margin-top:18px;">
                        <!-- [C=0查表頁面] 匯出至多計畫比較按鈕 -->
                        <button id="c0-export-to-plan-btn" class="main-btn" type="button">Export to Plan Comparison</button>
                        <!-- /[C=0查表頁面] -->
                    </div>
                    <!-- 移除 Show C=0 Sampling Table 與相關彈窗 -->
                </div>

                <div id="plan-controls" style="display:none; height: 100%;">
                    <div class="panel plan-merged-panel">
                        <h3><span style="color: var(--primary-color);">1.</span> Add Plan</h3>
                        <div class="input-grid">
                            <div class="input-group">
                                <label for="plan_n_input">Sample Size (n)</label>
                                <input type="number" id="plan_n_input" value="1250" min="1">
                            </div>
                            <div class="input-group">
                                <label for="plan_c_input">Acceptance No. (c)</label>
                                <input type="number" id="plan_c_input" value="10" min="0">
                            </div>
                            <div class="input-group">
                                <label for="plan_aql_input">AQL (%)</label>
                                <input type="number" id="plan_aql_input" value="0.4" min="0" step="0.01">
                            </div>
                            <div class="input-group">
                                <label for="plan_label_input">Plan Label</label>
                                <input type="text" id="plan_label_input" placeholder="e.g., Plan A">
                            </div>
                        </div>
                        <div class="button-group">
                            <!-- [多計畫比較頁面] 新增計畫按鈕 -->
                            <button id="add-plan-btn" class="btn-add btn-styled">Add Plan</button>
                            <!-- /[多計畫比較頁面] -->
                            <!-- [多計畫比較頁面] 清除全部按鈕 -->
                            <button id="clear-all-btn" class="btn-clear btn-styled">Clear All</button>
                            <!-- /[多計畫比較頁面] -->
                        </div>
                        <hr style="margin: 18px 0 12px 0; border: none; border-top: 1.5px solid #1783FF; opacity: 0.25;">
                        <h3 style="margin-top:0;"><span style="color: var(--primary-color);">2.</span> Added Plans</h3>
                        <ul id="plan-list" class="plan-list"></ul>
                    </div>
                </div>
                
                <div id="reverse-math-controls" class="panel" style="display:none; flex-direction: column; gap: 20px;">
                    <h3>Reverse Sampling Calculation</h3>
                    <div class="input-grid" style="grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div class="input-group">
                            <input type="checkbox" id="chk-math-aql" class="reverse-math-chk" checked>
                            <label for="math_aql_input">AQL (%)</label>
                            <input type="number" id="math_aql_input" min="0.01" max="1000" step="0.01" value="0.4">
                        </div>
                        <div class="input-group">
                            <input type="checkbox" id="chk-math-c" class="reverse-math-chk">
                            <label for="math_c_input">Acceptance No. (c)</label>
                            <input type="number" id="math_c_input" min="0" max="1000" step="1" value="">
                        </div>
                        <div class="input-group">
                            <input type="checkbox" id="chk-math-n" class="reverse-math-chk" checked>
                            <label for="math_n_input">Sample Size (n)</label>
                            <input type="number" id="math_n_input" min="1" max="10000" step="1" value="1250">
                        </div>
                        <div class="input-group">
                            <input type="checkbox" id="chk-math-N" class="reverse-math-chk" checked>
                            <label for="math_N_input">Lot Size (N)</label>
                            <input type="number" id="math_N_input" min="1" max="5000000" step="1" value="50000">
                        </div>
                    </div>
                    <div style="color: #aaa; font-size: 0.95em;">Acceptance probability Pa is set at the closest to 95%, distribution type auto-detected - Producer's Risk (α) fixed at about 5%</div>
                    <div id="reverse-math-error" style="color: red; display: none;"></div>
                    <div id="reverse-math-result-wrapper"></div>
                </div>

                <!-- [新增] Sampling Standard 控制面板 -->
                <div id="sampling-standard-controls" class="panel" style="display:none;">
                    <h3>Three Inspection Types</h3>
                    <div style="background: rgba(255,193,7,0.15); padding: 10px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #ffc107;">
                        <small style="color: #ffc107; font-weight: bold;">ℹ️ Note:</small>
                        <small style="color: #c7cacf; line-height: 1.4;">Based on ANSI/ASQ Z1.4-2003 standard for single sampling plans.</small>
                    </div>
                    <!-- 檢查類型按鈕 -->
                    <div class="input-group inspection-type-group" style="margin-bottom:20px;">
                        <div class="inspection-type-row">
                            <button type="button" class="inspection-type-btn active" data-type="normal">Normal</button>
                            <button type="button" class="inspection-type-btn" data-type="tightened">Tightened</button>
                            <button type="button" class="inspection-type-btn" data-type="reduced">Reduced</button>
                        </div>
                    </div>
                    <!-- 下拉選單控制項 -->
                    <div class="input-grid" style="grid-template-columns: 1fr;">
                        <div class="input-group">
                            <label for="ss-lot-size-select">Lot Size Range</label>
                            <select id="ss-lot-size-select" style="text-align:center; text-align-last:center;"><option value="">-- Select Lot Size --</option></select>
                        </div>
                        <div class="input-group">
                            <label for="ss-level-select">Inspection Level</label>
                            <select id="ss-level-select" style="text-align:center; text-align-last:center;">
                                <optgroup label="General Levels">
                                    <option value="I">I</option><option value="II" selected>II (Most Common)</option><option value="III">III</option>
                                </optgroup>
                                <optgroup label="Special Levels">
                                    <option value="S-1">S-1</option><option value="S-2">S-2</option><option value="S-3">S-3</option><option value="S-4">S-4</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="ss-aql-select">AQL (%)</label>
                            <select id="ss-aql-select" style="text-align:center; text-align-last:center;"><option value="">-- Select AQL --</option></select>
                        </div>
                    </div>
                    <!-- 查詢結果區 -->
                    <div id="ss-result-container" style="display:none; margin-top: 20px; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 8px; text-align: center;">
                        <h4 style="margin:0 0 15px 0; font-size:1.2em;">Query Result</h4>
                        <div style="display:flex; justify-content:space-around; text-align:center;">
                            <div>
                                <h5 style="margin:0 0 5px 0; font-size:0.9em; font-weight:400; color:rgba(255,255,255,0.7);">Sample Size (n)</h5>
                                <span id="ss-sample-size-result" style="font-size:1.8em; font-weight:700; color:#2ecc71;"></span>
                                <span id="ss-original-code-letter" style="font-size:1em; color:rgba(255,255,255,0.8); display:block;"></span>
                            </div>
                            <div>
                                <h5 style="margin:0 0 5px 0; font-size:0.9em; font-weight:400; color:rgba(255,255,255,0.7);">Acceptance No. (c)</h5>
                                <span id="ss-acceptance-number-result" style="font-size:1.8em; font-weight:700; color:#2ecc71;"></span>
                            </div>
                        </div>
                        <div style="margin-top: 15px; text-align: center;">
                            <button id="ss-export-to-plan-btn" class="main-btn" type="button">Export to Plan Comparison</button>
                        </div>
                    </div>
                    <div id="ss-error" style="color: #af2432; margin-top: 10px; text-align: center;"></div>
                </div>
            </div>
            
            <div class="chart-container">
                <div class="export-btn-group" style="display:flex; align-items:center; gap:12px;">
                    <!-- [圖表區] 匯出 PNG 按鈕 -->
                    <button id="btn-export-png" class="main-btn">Export PNG</button>
                    <!-- /[圖表區] -->
                    <!-- [圖表區] 匯出 Data 按鈕 -->
                    <button id="btn-export-csv" class="main-btn">Export Data</button>
                    <!-- /[圖表區] -->
                    <!-- [Distribution專用] Defect Rate Max 欄位 -->
                    <div id="dist-defect-rate-control" style="display:none; margin-left:auto; align-items:center; gap:8px;">
                        <label for="dist_x_axis_max_input" style="color:#c7cacf; font-size:0.9em; white-space:nowrap;">Defect Rate Max (%):</label>
                        <input type="number" id="dist_x_axis_max_input" value="5" min="1" step="0.5" style="width:80px; padding:4px 8px; text-align:center; border:1px solid #647281; border-radius:4px; background:rgba(255,255,255,0.1); color:#c7cacf; font-size:0.9em;">
                    </div>
                    <!-- [Plan專用] Defect Rate Max 欄位 -->
                    <div id="plan-defect-rate-control" style="display:none; margin-left:auto; align-items:center; gap:8px;">
                        <label for="plan_x_axis_max_input" style="color:#c7cacf; font-size:0.9em; white-space:nowrap;">Defect Rate Max (%):</label>
                        <input type="number" id="plan_x_axis_max_input" value="2" min="1" step="0.5" style="width:80px; padding:4px 8px; text-align:center; border:1px solid #647281; border-radius:4px; background:rgba(255,255,255,0.1); color:#c7cacf; font-size:0.9em;">
                    </div>
                    <!-- [Reverse專用] Defect Rate Max 欄位 -->
                    <div id="reverse-defect-rate-control" style="display:none; margin-left:auto; align-items:center; gap:8px;">
                        <label for="reverse_oc_x_axis_max_input" style="color:#c7cacf; font-size:0.9em; white-space:nowrap;">Defect Rate Max (%):</label>
                        <input type="number" id="reverse_oc_x_axis_max_input" value="2" min="1" max="100" step="0.5" style="width:80px; padding:4px 8px; text-align:center; border:1px solid #647281; border-radius:4px; background:rgba(255,255,255,0.1); color:#c7cacf; font-size:0.9em;">
                    </div>
                    <!-- [C=0專用] Defect Rate Max 欄位 -->
                    <div id="c0-defect-rate-control" style="display:none; margin-left:auto; align-items:center; gap:8px;">
                        <label for="c0_x_axis_max_input" style="color:#c7cacf; font-size:0.9em; white-space:nowrap;">Defect Rate Max (%):</label>
                        <input type="number" id="c0_x_axis_max_input" value="8" min="1" step="0.5" style="width:80px; padding:4px 8px; text-align:center; border:1px solid #647281; border-radius:4px; background:rgba(255,255,255,0.1); color:#c7cacf; font-size:0.9em;">
                    </div>
                    <!-- [Sampling Standard專用] Defect Rate Max 欄位 -->
                    <div id="ss-defect-rate-control" style="display:none; margin-left:auto; align-items:center; gap:8px;">
                        <label for="ss_x_axis_max_input" style="color:#c7cacf; font-size:0.9em; white-space:nowrap;">Defect Rate Max (%):</label>
                        <input type="number" id="ss_x_axis_max_input" value="3" min="1" step="0.5" style="width:80px; padding:4px 8px; text-align:center; border:1px solid #647281; border-radius:4px; background:rgba(255,255,255,0.1); color:#c7cacf; font-size:0.9em;">
                    </div>
                </div>
                <canvas id="ocChart"></canvas>
            </div>
        </div>
        
        <footer>
            Developed by Wesley Chang (3kids68@gmail.com). All Rights Reserved.
        </footer>
        <!-- 移除舊版 kaiyi 影像與 Code Letters/Master Tables，改以統一的 Sampling Standard 控制區 -->
        <!-- 抽樣計畫原理說明彈窗 -->
        <div id="sampling-theory-modal-bg">
            <div id="sampling-theory-modal">
                <div class="container">
                    <header>
                        <h1>An In-Depth Look at Sampling Plan Principles</h1>
                        <p>The Journey from User to Expert</p>
                    </header>
                    <!-- Introduction Card -->
                    <div class="content-card">
                        <p>Sampling plan tables (such as ISO 2859-1 or ANSI/ASQ Z1.4) may look like a bunch of numbers for reference, but they are based on deep statistical principles and mathematical models. Understanding these principles can turn you from a "tool user" into an "expert who understands the tool's theory".</p>
                        <ul>
                            <li><strong>The core goal of a sampling plan table is to balance Producer's Risk (α) and Consumer's Risk (β).</strong> The underlying math is mainly based on three probability distributions: binomial, Poisson, and hypergeometric.</li>
                        </ul>
                    </div>
                
                    <!-- OC Curve Card -->
                    <div class="content-card">
                        <h2 class="concept-title">Core Concept: Operating Characteristic (OC) Curve</h2>
                        <p>To understand sampling plan tables, you must first understand the OC curve. Each sampling plan (defined by sample size <span class="formula-text">n</span> and acceptance number <span class="formula-text">Ac</span>) corresponds to a unique OC curve.</p>
                        
                        <h3 class="concept-subtitle">What is an OC curve?</h3>
                        <p>It is a chart with the x-axis as the actual lot defect rate (<span class="formula-text">p</span>) and the y-axis as the probability of the lot being accepted (<span class="formula-text">Pa</span>).</p>
                
                        <h3 class="concept-subtitle">What does it tell us?</h3>
                        <p>It describes the "behavioral characteristics" of a sampling plan. For a given plan (e.g., n=80, Ac=2), the OC curve can answer: *"If the actual defect rate of this lot is 3%, what is the probability it will pass our sampling inspection?"*</p>
                
                        <h3 class="concept-subtitle">Ideal vs. Reality</h3>
                        <ul>
                            <li>The <strong>ideal OC curve</strong> is a vertical cliff. When the defect rate is below a certain standard, the acceptance probability is 100%; once above the standard, the acceptance probability drops to 0%. This is impossible in reality.</li>
                            <li>The <strong>real OC curve</strong> is a smooth S-shape. This means there is always risk.</li>
                        </ul>
                    </div>
                
                    <!-- Risks Card -->
                    <div class="content-card">
                        <h2 class="risk-title">The Balance of Two Major Risks</h2>
                        <p>There are two very critical points on the OC curve, which are the two major risks that sampling plans must balance:</p>
                        
                        <div class="risk-card producer-risk">
                            <h4>1. Producer's Risk (α)</h4>
                            <ul>
                                <li><strong>Definition:</strong> The probability that a <strong>good lot</strong> is wrongly <strong>rejected</strong> by the sampling plan.</li>
                                <li><strong>Corresponding point:</strong> On the OC curve, this point is usually related to the <strong>Acceptable Quality Level (AQL)</strong>. AQL is defined as "the worst process average considered acceptable in the sampling plan." When the lot defect rate equals the AQL, the acceptance probability is usually high (e.g., 95%). The probability of rejection (α) is then 5%.</li>
                                <li><strong>In plain terms:</strong> Producers do not want their good products to be wrongly rejected. AQL protects the producer's interests.</li>
                            </ul>
                        </div>
                        
                        <div class="risk-card consumer-risk">
                            <h4>2. Consumer's Risk (β)</h4>
                            <ul>
                                <li><strong>Definition:</strong> The probability that a <strong>bad lot</strong> is wrongly <strong>accepted</strong> by the sampling plan.</li>
                                <li><strong>Corresponding point:</strong> This point is usually related to the <strong>Lot Tolerance Percent Defective (LTPD)</strong> or Rejectable Quality Level (RQL). LTPD is the worst quality level the consumer can tolerate. When the lot defect rate reaches LTPD, the acceptance probability (β) is usually low (e.g., 10%).</li>
                                <li><strong>In plain terms:</strong> Consumers do not want to receive bad products. LTPD protects the consumer's interests.</li>
                            </ul>
                        </div>
                
                        <p style="margin-top: 2rem;"><strong>The design of sampling plan tables is essentially the design of a series of OC curves,</strong> so that for each given AQL, the corresponding producer's risk α is relatively fixed (usually around 5%).</p>
                    </div>
                
                    <!-- Mathematical Models Card -->
                    <div class="content-card">
                        <h2 class="math-title">Underlying Mathematical Models (The Calculation Engine)</h2>
                        <p>So how is each point (acceptance probability <span class="formula-text">Pa</span>) on the OC curve calculated? This is where probability distribution models come in.</p>
                
                        <h3 class="math-subtitle">1. Hypergeometric Distribution</h3>
                        <ul>
                            <li><strong>Application:</strong> When samples are drawn from a finite, isolated lot without replacement, this is the most precise model.</li>
                            <li><strong>Calculation:</strong> Calculate the probability of drawing exactly <span class="formula-text">x</span> defectives in <span class="formula-text">n</span> samples from a lot of <span class="formula-text">N</span> items with <span class="formula-text">D</span> defectives.</li>
                            <li>Formula: <span class="formula-text">P(x) = [C(D, x) * C(N-D, n-x)] / C(N, n)</span></li>
                            <li><strong>Practical use:</strong> Most accurate, but very complex for large <span class="formula-text">N</span> and <span class="formula-text">D</span>. In practice, the following approximations are often used.</li>
                        </ul>
                
                        <h3 class="math-subtitle">2. Binomial Distribution</h3>
                        <ul>
                            <li><strong>Application:</strong> When the lot is very large (theoretically infinite), or sampling from a continuous production stream. It is a good approximation of the hypergeometric when <span class="formula-text">N >> n</span>.</li>
                            <li><strong>Calculation:</strong> Probability of exactly <span class="formula-text">x</span> defectives in <span class="formula-text">n</span> independent trials (each with defect rate <span class="formula-text">p</span>).</li>
                            <li>Formula: <span class="formula-text">P(x) = C(n, x) * p^x * (1-p)^(n-x)</span></li>
                            <li><strong>Acceptance probability (Pa):</strong> Sum of probabilities for <span class="formula-text">x=0</span> to <span class="formula-text">Ac</span>. Pa = Σ P(x) (from <span class="formula-text">x=0</span> to <span class="formula-text">Ac</span>).</li>
                        </ul>
                
                        <h3 class="math-subtitle">3. Poisson Distribution</h3>
                        <ul>
                            <li><strong>Application:</strong> When <span class="formula-text">n</span> is large and <span class="formula-text">p</span> is small, Poisson is an excellent and simpler approximation of the binomial. This is very common in quality management sampling plans.</li>
                            <li><strong>Calculation:</strong> Probability of <span class="formula-text">x</span> events (defectives) occurring in <span class="formula-text">n</span> samples, with average λ = <span class="formula-text">n*p</span>.</li>
                            <li>Formula: <span class="formula-text">P(x) = (e^(-λ) * λ^x) / x!</span></li>
                            <li><strong>Acceptance probability (Pa):</strong> Again, sum for <span class="formula-text">x=0</span> to <span class="formula-text">Ac</span>.</li>
                            <li><strong>Core engine:</strong> Most ISO 2859-1 calculations are based on Poisson, as it is simple and very close to binomial in typical industrial scenarios.</li>
                        </ul>
                    </div>
                    
                    <!-- How a Table is Made Card -->
                    <div class="content-card">
                        <h2>How a Sampling Plan Table is Made (A Simplified View)</h2>
                        <p>Let's simulate how standards committees think:</p>
                        <ol>
                            <li><strong>Determine AQL values:</strong> First, define a series of standardized AQL values (e.g., 0.65%, 1.0%, 1.5%, etc.).</li>
                            <li><strong>Set producer's risk α:</strong> Decide that when the actual defect rate equals AQL, the acceptance probability <span class="formula-text">Pa</span> should be high, e.g., <span class="formula-text">Pa ≈ 95%</span>. This means producer's risk α ≈ 5%.</li>
                            <li><strong>Calculate for each code letter:</strong> For each code letter (e.g., G, H, J, K...), which corresponds to a fixed sample size <span class="formula-text">n</span>.
                                <ul><li><strong>Goal:</strong> For this <span class="formula-text">n</span> and given AQL, find an acceptance number <span class="formula-text">Ac</span> so that when <span class="formula-text">p = AQL</span>, <span class="formula-text">Pa</span> is as close as possible to 95%.</li></ul>
                            </li>
                            <li><strong>Start iterative calculation (using Poisson as an example):</strong>
                                <ul>
                                    <li><strong>Example:</strong> Code letter "J" (<span class="formula-text">n=80</span>), AQL=1.0%.</li>
                                    <li><strong>Calculate λ:</strong> <span class="formula-text">λ = n * p = 80 * 0.01 = 0.8</span>.</li>
                                    <li><strong>Try Ac=0:</strong> <span class="formula-text">Pa = P(0) = (e^-0.8 * 0.8^0) / 0! = 0.449 (44.9%)</span>. Too low.</li>
                                    <li><strong>Try Ac=1:</strong> <span class="formula-text">Pa = P(0) + P(1) = 0.449 + 0.359 = 0.808 (80.8%)</span>. Still low.</li>
                                    <li><strong>Try Ac=2:</strong> <span class="formula-text">Pa = P(0) + P(1) + P(2) = 0.808 + 0.144 = 0.952 (95.2%)</span>.</li>
                                    <li><strong>Bingo!</strong> <span class="formula-text">Ac=2</span> gives <span class="formula-text">Pa</span> (95.2%) very close to our target (95%).</li>
                                </ul>
                            </li>
                            <li><strong>Fill the table:</strong> So, in the table, the entry for code letter "J" and AQL 1.0% will be <span class="formula-text">Ac=2</span>, <span class="formula-text">Re=3</span>.</li>
                            <li><strong>Handle arrows:</strong> If for some combinations (usually <span class="formula-text">n</span> is too small for a strict AQL), even <span class="formula-text">Ac=0</span> gives <span class="formula-text">Pa >> 95%</span>, it means the plan is too lenient for the producer. The table will point to a plan with a larger <span class="formula-text">n</span> for better discrimination.</li>
                        </ol>
                        <p>By repeating this for all code letters and AQLs, a complete sampling plan table is created. It is a huge family of OC curves, cleverly condensed into a table for users to apply directly without complex calculations.</p>
                    </div>
                
                    <!-- Summary Card -->
                    <div class="summary">
                        <p>In summary, sampling plan tables are a great application of probability and statistical decision theory, aiming to provide industry with a scientific, fair, and efficient quality decision tool under conditions of uncertainty.</p>
                    </div>
             
                </div>
                <button onclick="document.getElementById('sampling-theory-modal-bg').style.display='none'" style="margin:32px auto 0 auto; display:block; background:#FFD700; color:#222; font-weight:bold; font-size:1.1em; border:none; border-radius:8px; padding:10px 32px; cursor:pointer;">Close Table</button>
            </div>
        </div>
    </div>

    <script>

        // [新增] C=0 抽樣計畫資料表
        const C0_SAMPLING_TABLE = [
            {'lot_range': [2, 8], 'samples': {'0.010': null, '0.015': null, '0.025': null, '0.040': null, '0.065': null, '0.10': null, '0.15': null, '0.25': null, '0.40': null, '0.65': null, '1.0': null, '1.5': null, '2.5': 5, '4.0': 3, '6.5': 2, '10.0': 2}},
            {'lot_range': [9, 15], 'samples': {'0.010': null, '0.015': null, '0.025': null, '0.040': null, '0.065': null, '0.10': null, '0.15': null, '0.25': null, '0.40': null, '0.65': null, '1.0': 13, '1.5': 8, '2.5': 5, '4.0': 3, '6.5': 2, '10.0': 2}},
            {'lot_range': [16, 25], 'samples': {'0.010': null, '0.015': null, '0.025': null, '0.040': null, '0.065': null, '0.10': null, '0.15': null, '0.25': null, '0.40': null, '0.65': 20, '1.0': 13, '1.5': 8, '2.5': 5, '4.0': 3, '6.5': 3, '10.0': 2}},
            {'lot_range': [26, 50], 'samples': {'0.010': null, '0.015': null, '0.025': null, '0.040': null, '0.065': null, '0.10': null, '0.15': null, '0.25': null, '0.40': 32, '0.65': 20, '1.0': 13, '1.5': 8, '2.5': 5, '4.0': 5, '6.5': 5, '10.0': 3}},
            {'lot_range': [51, 90], 'samples': {'0.010': null, '0.015': null, '0.025': null, '0.040': null, '0.065': null, '0.10': null, '0.15': 80, '0.25': 50, '0.40': 32, '0.65': 20, '1.0': 13, '1.5': 8, '2.5': 7, '4.0': 6, '6.5': 5, '10.0': 4}},
            {'lot_range': [91, 150], 'samples': {'0.010': null, '0.015': null, '0.025': null, '0.040': null, '0.065': null, '0.10': 125, '0.15': 80, '0.25': 50, '0.40': 32, '0.65': 20, '1.0': 13, '1.5': 12, '2.5': 11, '4.0': 7, '6.5': 6, '10.0': 5}},
            {'lot_range': [151, 280], 'samples': {'0.010': null, '0.015': null, '0.025': null, '0.040': 200, '0.065': 125, '0.10': 80, '0.15': 50, '0.25': 32, '0.40': 20, '0.65': 20, '1.0': 19, '1.5': 13, '2.5': 13, '4.0': 10, '6.5': 7, '10.0': 6}},
            {'lot_range': [281, 500], 'samples': {'0.010': null, '0.015': null, '0.025': null, '0.040': 315, '0.065': 200, '0.10': 125, '0.15': 80, '0.25': 50, '0.40': 48, '0.65': 47, '1.0': 29, '1.5': 21, '2.5': 16, '4.0': 11, '6.5': 9, '10.0': 7}},
            {'lot_range': [501, 1200], 'samples': {'0.010': null, '0.015': 800, '0.025': 500, '0.040': 315, '0.065': 200, '0.10': 125, '0.15': 80, '0.25': 75, '0.40': 73, '0.65': 47, '1.0': 34, '1.5': 27, '2.5': 19, '4.0': 15, '6.5': 11, '10.0': 8}},
            {'lot_range': [1201, 3200], 'samples': {'0.010': 1250, '0.015': 800, '0.025': 500, '0.040': 315, '0.065': 200, '0.10': 125, '0.15': 120, '0.25': 116, '0.40': 73, '0.65': 53, '1.0': 42, '1.5': 35, '2.5': 23, '4.0': 18, '6.5': 13, '10.0': 9}},
            {'lot_range': [3201, 10000], 'samples': {'0.010': 1250, '0.015': 800, '0.025': 500, '0.040': 315, '0.065': 200, '0.10': 192, '0.15': 189, '0.25': 116, '0.40': 86, '0.65': 68, '1.0': 50, '1.5': 38, '2.5': 29, '4.0': 22, '6.5': 15, '10.0': 9}},
            {'lot_range': [10001, 35000], 'samples': {'0.010': 1250, '0.015': 800, '0.025': 500, '0.040': 315, '0.065': 300, '0.10': 294, '0.15': 189, '0.25': 135, '0.40': 108, '0.65': 77, '1.0': 60, '1.5': 46, '2.5': 35, '4.0': 29, '6.5': 15, '10.0': 9}},
            {'lot_range': [35001, 150000], 'samples': {'0.010': 1250, '0.015': 800, '0.025': 500, '0.040': 490, '0.065': 476, '0.10': 294, '0.15': 218, '0.25': 170, '0.40': 123, '0.65': 96, '1.0': 74, '1.5': 56, '2.5': 40, '4.0': 29, '6.5': 15, '10.0': 9}},
            {'lot_range': [150001, 500000], 'samples': {'0.010': 1250, '0.015': 800, '0.025': 750, '0.040': 715, '0.065': 476, '0.10': 345, '0.15': 270, '0.25': 200, '0.40': 156, '0.65': 119, '1.0': 90, '1.5': 64, '2.5': 40, '4.0': 29, '6.5': 15, '10.0': 9}},
            {'lot_range': [500001, Infinity], 'samples': {'0.010': 1250, '0.015': 1200, '0.025': 1112, '0.040': 715, '0.065': 556, '0.10': 435, '0.15': 303, '0.25': 244, '0.40': 189, '0.65': 143, '1.0': 102, '1.5': 64, '2.5': 40, '4.0': 29, '6.5': 15, '10.0': 9}},
        ];
        
        // [重新設計] C=0 抽樣計畫查詢結構 - 逆向查詢（先選n，再查AQL）
        
        // 第一步：建立逆向查詢表結構（從n查AQL）
        function buildC0ReverseLookupTable() {
            const lookupTable = new Map();
            
            // 為每個批量範圍建立對應的樣本數到AQL的對應關係
            C0_SAMPLING_TABLE.forEach((row, rowIndex) => {
                const [min, max] = row.lot_range;
                const lotRangeKey = `${min}-${max === Infinity ? 'inf' : max}`;
                
                // 建立樣本數到AQL的對應
                const sampleToAqlMap = new Map();
                Object.entries(row.samples).forEach(([aql, sampleSize]) => {
                    if (sampleSize !== null && sampleSize !== undefined) {
                        if (!sampleToAqlMap.has(sampleSize)) {
                            sampleToAqlMap.set(sampleSize, []);
                        }
                        sampleToAqlMap.get(sampleSize).push(aql);
                    }
                });
                
                // 提取所有有效的樣本數（排序）
                const availableSampleSizes = Array.from(sampleToAqlMap.keys()).sort((a, b) => a - b);
                
                lookupTable.set(lotRangeKey, {
                    lotRange: [min, max],
                    sampleToAqlMap: sampleToAqlMap,
                    availableSampleSizes: availableSampleSizes
                });
            });
            
            return lookupTable;
        }
        
        // 第二步：逆向查詢函數（根據批量範圍和樣本數查找AQL）
        function getC0AqlBySampleSize(lotSizeRange, sampleSize) {
            const lookupTable = buildC0ReverseLookupTable();
            
            if (lotSizeRange && sampleSize) {
                const [min, max] = lotSizeRange.split(',').map(Number);
                const lotRangeKey = `${min}-${max === Infinity ? 'inf' : max}`;
                
                const tableData = lookupTable.get(lotRangeKey);
                if (tableData && tableData.sampleToAqlMap.has(sampleSize)) {
                    const aqls = tableData.sampleToAqlMap.get(sampleSize);
                    // 如果有多個AQL對應同一個樣本數，返回最小的
                    return aqls.sort((a, b) => parseFloat(a) - parseFloat(b))[0];
                }
            }
            
            return null;
        }
        
        // 第三步：獲取批量範圍對應的有效樣本數
        function getAvailableSampleSizes(lotSizeRange) {
            const lookupTable = buildC0ReverseLookupTable();
            
            if (lotSizeRange) {
                const [min, max] = lotSizeRange.split(',').map(Number);
                const lotRangeKey = `${min}-${max === Infinity ? 'inf' : max}`;
                
                const tableData = lookupTable.get(lotRangeKey);
                if (tableData) {
                    return tableData.availableSampleSizes;
                }
            }
            
            // 如果沒有指定範圍，返回所有可能的樣本數
            const allSampleSizes = new Set();
            lookupTable.forEach(data => {
                data.availableSampleSizes.forEach(size => allSampleSizes.add(size));
            });
            
            return Array.from(allSampleSizes).sort((a, b) => a - b);
        }
        
        
        // [添加] 清理圖表函數
        function clearReverseOCChart() {
            if (ocChart) {
                ocChart.data.datasets = [];
                ocChart.options.plugins.annotation.annotations = {};
                ocChart.options.plugins.title.text = '';
                ocChart.update();
            }
        }
        
        // [修正] C=0 抽樣計畫查詢函式
        function get_c0_sample_size(lot_size, aql) {
            if (isNaN(lot_size) || lot_size < 2) {
                return { error: "Lot size must be an integer greater than or equal to 2." };
            }

            for (const row of C0_SAMPLING_TABLE) {
                const [min_lot, max_lot] = row.lot_range;
                if (lot_size >= min_lot && lot_size <= max_lot) {
                    const sample_size = row.samples[aql];
                    if (sample_size !== undefined && sample_size !== null) {
                        return { n: sample_size, c: 0 };
                    } else if (sample_size === null) {
                        return { error: "C=0 plan is not recommended for this lot size and AQL combination." };
                    } else {
                        return { error: `AQL '${aql}%' not found.` };
                    }
                }
            }
            return { error: "Unknown error occurred." };
        }

        // === 全域色碼轉 RGBA 工具 ===
        function hexOrRgbaToRgba(color, alpha) {
            if (!color || typeof color !== 'string') {
                return `rgba(52,152,219,${alpha})`;
            }
            if (color.startsWith('#')) {
                let hex = color.replace('#', '');
                if (hex.length === 3) hex = hex.split('').map(x => x + x).join('');
                if (!/^[0-9a-fA-F]{6}$/.test(hex)) return `rgba(52,152,219,${alpha})`;
                const num = parseInt(hex, 16);
                return `rgba(${(num >> 16) & 255},${(num >> 8) & 255},${num & 255},${alpha})`;
            } else if (color.startsWith('rgb')) {
                return color.replace(/rgb(a?)\(([^)]+)\)/, (m, a, v) => {
                    const parts = v.split(',').map(x => parseInt(x));
                    if (parts.length < 3 || parts.some(isNaN)) return `rgba(52,152,219,${alpha})`;
                    return `rgba(${parts[0]},${parts[1]},${parts[2]},${alpha})`;
                });
            } else {
                return `rgba(52,152,219,${alpha})`;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {

            // --- 全局變數和狀態 ---
            let currentMode = 'distribution'; // 'distribution', 'plan', 'reverse', 'c0_plan'
            let ocChart;
            let samplingPlans = []; // 用於計畫比較模式
            let reverseSamplingPlans = []; // 用於逆向查詢模式
            const planColors = ['#1783FF', '#e74c3c', '#2ecc71', '#f1c40f', '#9b59b6', '#1abc9c', '#e67e22'];
            let planCounter = 1;

            // --- Crosshair Plugin ---
            let crosshair = { x: null, y: null };
            const crosshairPlugin = {
                id: 'crosshair',
                afterEvent(chart, args) {
                    const event = args.event;
                    if (event && event.type === 'mousemove' && event.x && event.y) {
                        crosshair.x = event.x;
                        crosshair.y = event.y;
                        chart.draw();
                    } else if (event && (event.type === 'mouseout' || event.type === 'mouseleave')) {
                        crosshair.x = null;
                        crosshair.y = null;
                        chart.draw();
                    }
                },
                afterDraw(chart) {
                    if (crosshair.x === null || crosshair.y === null) return;
                    const ctx = chart.ctx;
                    ctx.save();
                    ctx.setLineDash([6, 6]);
                    ctx.strokeStyle = 'rgba(255,255,255,0.5)';
                    ctx.lineWidth = 1.2;
                    // 垂直線
                    ctx.beginPath();
                    ctx.moveTo(crosshair.x, chart.chartArea.top);
                    ctx.lineTo(crosshair.x, chart.chartArea.bottom);
                    ctx.stroke();
                    // 水平線
                    ctx.beginPath();
                    ctx.moveTo(chart.chartArea.left, crosshair.y);
                    ctx.lineTo(chart.chartArea.right, crosshair.y);
                    ctx.stroke();
                    ctx.restore();
                }
            };

            // === 新增：滑鼠移動顯示曲線座標標籤 Plugin ===
            const hoverLabelPlugin = {
                id: 'hoverLabel',
                afterDraw(chart) {
                    // 取得滑鼠座標
                    const event = chart._active && chart._active.length ? chart._active[0] : (chart.lastEvent || null);
                    let mouseX, mouseY;
                    if (event && event.x !== undefined && event.y !== undefined) {
                        mouseX = event.x;
                        mouseY = event.y;
                    } else if (chart._lastEvent && chart._lastEvent.x !== undefined) {
                        mouseX = chart._lastEvent.x;
                        mouseY = chart._lastEvent.y;
                    } else {
                        return;
                    }

                    // 搜尋所有資料點，找出最近的點
                    let minDist = Infinity;
                    let nearest = null;
                    chart.data.datasets.forEach((ds, dsIdx) => {
                        const meta = chart.getDatasetMeta(dsIdx);
                        if (!meta || !meta.data) return;
                        meta.data.forEach((elem, idx) => {
                            const pos = elem.getProps(['x', 'y'], true);
                            const dx = pos.x - mouseX;
                            const dy = pos.y - mouseY;
                            const dist = Math.sqrt(dx*dx + dy*dy);
                            if (dist < minDist) {
                                minDist = dist;
                                nearest = { ds, dsIdx, idx, pos };
                            }
                        });
                    });
                    if (!nearest) return;

                    const point = nearest.ds.data[nearest.idx];
                    const label = `${nearest.ds.label}\np: ${point.x.toFixed(2)}%\nPa: ${(point.y*100).toFixed(2)}%`;
                    const labelX = nearest.pos.x + 16;
                    const labelY = nearest.pos.y - 24;

                    const ctx = chart.ctx;
                    ctx.save();
                    ctx.font = 'bold 13px Noto Sans TC, sans-serif';
                    ctx.textAlign = 'left';
                    ctx.textBaseline = 'top';
                    const lines = label.split('\n');
                    const width = Math.max(...lines.map(l => ctx.measureText(l).width)) + 16;
                    const height = lines.length * 18 + 8;
                    ctx.fillStyle = 'rgba(44,62,80,0.95)';
                    ctx.strokeStyle = '#fff';
                    ctx.lineWidth = 2;
                    if (ctx.roundRect) {
                        ctx.beginPath();
                        ctx.roundRect(labelX, labelY, width, height, 8);
                        ctx.fill();
                        ctx.stroke();
                    } else {
                        ctx.fillRect(labelX, labelY, width, height);
                        ctx.strokeRect(labelX, labelY, width, height);
                    }
                    ctx.fillStyle = '#fff';
                    lines.forEach((l, i) => {
                        ctx.fillText(l, labelX + 8, labelY + 6 + i * 18);
                    });
                    ctx.restore();
                }
            };

            // --- Plan Info Plugin (MODIFIED) ---
            const planInfoPlugin = {
                id: 'planInfo',
                afterDraw(chart) {
                    if (typeof currentMode !== 'undefined' && currentMode === 'plan' && typeof samplingPlans !== 'undefined' && samplingPlans.length > 0) {
                        const ctx = chart.ctx;
                        ctx.save();
                        ctx.font = 'bold 15px Noto Sans TC, sans-serif';
                        ctx.textAlign = 'right';
                        ctx.textBaseline = 'top';
                        let x = chart.chartArea.right - 10;
                        let y = chart.chartArea.top + 10;
                        samplingPlans.forEach((plan, idx) => {
                            let info = `${plan.label}: n=${plan.n}, c=${plan.c}`;
                            if (plan.aql !== null && plan.aql !== undefined)
                                info = `${plan.label}: AQL=${(plan.aql*100).toFixed(2)}%, n=${plan.n}, c=${plan.c}`;
                            ctx.fillStyle = plan.color;
                            ctx.shadowColor = 'rgba(0,0,0,0.25)';
                            ctx.shadowBlur = 2;
                            ctx.fillText(info, x, y + idx * 22);
                        });
                        ctx.restore();
                    }
                }
            };

            // --- DOM 元素 ---
            const headerTitle = document.getElementById('header-title');
            const headerSubtitle = document.getElementById('header-subtitle');
            const modeRadios = document.querySelectorAll('input[name="mode"]');
            const distributionControls = document.getElementById('distribution-controls');
            const planControls = document.getElementById('plan-controls');
            const ctx = document.getElementById('ocChart').getContext('2d');
            
            const distLotSizeInput = document.getElementById('dist_lot_size_input');
            const distNInput = document.getElementById('dist_n_input');
            const distCInput = document.getElementById('dist_c_input');
            const distXAxisMaxInput = document.getElementById('dist_x_axis_max_input');
            const showHypergeometricCheckbox = document.getElementById('show-hypergeometric');
            const showBinomialCheckbox = document.getElementById('show-binomial');
            const showPoissonCheckbox = document.getElementById('show-poisson');
            const planNInput = document.getElementById('plan_n_input');
            const planCInput = document.getElementById('plan_c_input');
            const planAqlInput = document.getElementById('plan_aql_input');
            const planLabelInput = document.getElementById('plan_label_input');
            const planXAxisMaxInput = document.getElementById('plan_x_axis_max_input');
            const addPlanBtn = document.getElementById('add-plan-btn');
            const clearAllBtn = document.getElementById('clear-all-btn');
            const planList = document.getElementById('plan-list');

            // [新增] C=0 DOM 元素
            const c0PlanControls = document.getElementById('c0-plan-controls');
            const c0LotSizeInput = document.getElementById('c0_lot_size_select');
            const c0NSelect = document.getElementById('c0_n_select');
            const c0XAxisMaxInput = document.getElementById('c0_x_axis_max_input');
            const c0Result = document.getElementById('c0-result');
            const c0LqInfo = document.getElementById('c0-lq-info');
            const c0Error = document.getElementById('c0-error');
            // [新增] 匯出至多計畫比較按鈕
            const c0ExportToPlanBtn = document.getElementById('c0-export-to-plan-btn');
            
            // --- 初始化 Chart.js ---
            function initializeChart() {
                ocChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels: [], datasets: [] },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: false,
                        devicePixelRatio: 4, // 提升畫布渲染解析度，使圖表更清晰
                        plugins: {
                            title: { display: true, text: '', font: { size: 18, family: 'Noto Sans TC' }, color: '#c7cacf' },
                            legend: { display: true, position: 'top', labels: { color: '#c7cacf', font: { size: 12, family: 'Noto Sans TC' }, boxWidth: 30, filter: (legendItem) => !legendItem.text.includes('AQL') && !legendItem.text.includes('LTPD') } },
                            annotation: { annotations: {} },
                            tooltip: { enabled: false }
                        },
                        layout: {
                            padding: {
                                bottom: 48
                            }
                        },
                        scales: {
                            x: {
                                type: 'linear',
                                title: { display: true, text: 'Defect Rate (p%)', color: '#c7cacf', font: { size: 14, family: 'Noto Sans TC' } },
                                ticks: { color: '#c7cacf', callback: (value) => value.toFixed(1) + '%' },
                                grid: { color: 'rgba(199,202,207,0.22)' },
                                min: 0
                            },
                            y: {
                                title: { display: true, text: 'Acceptance Probability (Pa%)', color: '#c7cacf', font: { size: 14, family: 'Noto Sans TC' } },
                                min: 0,
                                max: 1,
                                ticks: { color: '#c7cacf', callback: (value) => (value * 100).toFixed(0) + '%' },
                                grid: { color: 'rgba(199,202,207,0.22)' }
                            }
                        }
                    },
                    plugins: [crosshairPlugin, planInfoPlugin, hoverLabelPlugin]
                });
            }

            // --- 核心計算函數 ---
            function generatePValues(maxXPercent) {
                const step = 0.0005;
                const maxXDecimal = maxXPercent / 100;
                const numPoints = Math.floor(maxXDecimal / step) + 1;
                return Array.from({ length: numPoints }, (_, i) => i * step);
            }
            function getOCData(plan, pValues) {
                if (plan.distType === 'Hypergeometric' && plan.N) {
                    return pValues.map(p => {
                        const K = Math.round(plan.N * p);
                        if (plan.n > plan.N || K > plan.N || plan.c < 0 || plan.c > plan.n || plan.c > K || (plan.n - plan.c) > (plan.N - K) || plan.N === 0) {
                            return { x: p * 100, y: NaN };
                        }
                        return { x: p * 100, y: jStat.hypgeom.cdf(plan.c, plan.N, K, plan.n) };
                    });
                }
                if (plan.distType === 'Poisson') {
                    return pValues.map(p => ({ x: p * 100, y: jStat.poisson.cdf(plan.c, plan.n * p) }));
                }
                return pValues.map(p => ({ x: p * 100, y: jStat.binomial.cdf(plan.c, plan.n, p) }));
            }
            // --- 模式切換邏輯 ---
            function switchMode(newMode) {
                currentMode = newMode;
                reverseSamplingPlans = []; 

                const chartContainer = document.querySelector('.chart-container');
                const contentWrapper = document.querySelector('.content-wrapper');
                const kaiyiContainer = document.getElementById('kaiyi-image-container');
                const reverseControls = document.getElementById('reverse-math-controls');
                const samplingControls = document.getElementById('sampling-standard-controls');

                distributionControls.style.display = 'none';
                planControls.style.display = 'none';
                reverseControls.style.display = 'none';
                c0PlanControls.style.display = 'none'; // [新增] 隱藏C=0面板
                chartContainer.style.display = 'none';
                contentWrapper.style.display = 'none';
                if (kaiyiContainer) kaiyiContainer.style.display = 'none';
                if (samplingControls) samplingControls.style.display = 'none';
                // 隱藏所有Defect Rate Max控制項
                document.getElementById('dist-defect-rate-control').style.display = 'none';
                document.getElementById('plan-defect-rate-control').style.display = 'none';
                document.getElementById('reverse-defect-rate-control').style.display = 'none';
                document.getElementById('c0-defect-rate-control').style.display = 'none';
                document.getElementById('ss-defect-rate-control').style.display = 'none';
                
                // 清除所有圖表，確保模式切換時圖表也相應清除
                clearReverseOCChart();

                if (newMode === 'distribution') {
                    headerTitle.textContent = 'Acceptance Probability Distribution';
                    headerSubtitle.textContent = 'Interactive Analysis of Different Acceptance Probability Distributions';
                    distributionControls.style.display = 'block';
                    chartContainer.style.display = 'block';
                    contentWrapper.style.display = 'flex';
                    // 顯示Distribution模式的Defect Rate Max控制項
                    document.getElementById('dist-defect-rate-control').style.display = 'flex';
                } else if (newMode === 'plan') {
                    headerTitle.textContent = 'Comparison of Different Sampling Plans';
                    headerSubtitle.textContent = 'Interactive Analysis of Different Sampling Plans (using binomial distribution calculation)';
                    planControls.style.display = 'flex';
                    chartContainer.style.display = 'block';
                    contentWrapper.style.display = 'flex';
                    // 顯示Plan模式的Defect Rate Max控制項
                    document.getElementById('plan-defect-rate-control').style.display = 'flex';
                } else if (newMode === 'kaiyi') {
                    headerTitle.textContent = 'AQL Plan Visualization';
                    headerSubtitle.textContent = 'Visualize Sampling Standard (ANSI/ASQ Z1.4-2003)';
                    const samplingControls = document.getElementById('sampling-standard-controls');
                    if (samplingControls) samplingControls.style.display = 'block';
                    chartContainer.style.display = 'block';
                    contentWrapper.style.display = 'flex';
                    document.getElementById('ss-defect-rate-control').style.display = 'flex';
                    // 依據 Sampling Standard 目前按鈕狀態切換查表資料集
                    const activeSSBtn = document.querySelector('#sampling-standard-controls .inspection-type-btn.active');
                    if (activeSSBtn && typeof switchInspectionType === 'function') {
                        const type = activeSSBtn.getAttribute('data-type') || 'normal';
                        switchInspectionType(type);
                    }
                    // 進入 Sampling Standard 時立即繪圖（若已有選項值）
                    if (typeof performSSQuery === 'function') {
                        setTimeout(() => { performSSQuery(true); }, 0);
                    }
                } else if (newMode === 'reverse') {
                    headerTitle.textContent = 'Reverse Sampling Query (Formula Calculation)';
                    headerSubtitle.textContent = 'Choose any three of AQL, Acceptance Number, Sample Size, and Lot Size to calculate the remaining parameters';
                    reverseControls.style.display = 'flex';
                    chartContainer.style.display = 'block';
                    contentWrapper.style.display = 'flex';
                    // 顯示Reverse模式的Defect Rate Max控制項
                    document.getElementById('reverse-defect-rate-control').style.display = 'flex';
                    updateReverseInputDisabledState();
                    clearReverseOCChart(); // 確保切換時清空圖表
                    // 自動觸發查詢以顯示預設值的結果
                    setTimeout(() => { doReverseQuery(); }, 100);
                } else if (newMode === 'c0_plan') { // [新增] C=0模式處理
                    headerTitle.textContent = 'Nicholas L. Squeglia\'s specialized standard';
                    headerSubtitle.textContent = 'Zero Acceptance Sampling Plan Query Based on Consumer Risk';
                    c0PlanControls.style.display = 'block';
                    chartContainer.style.display = 'block';
                    contentWrapper.style.display = 'flex';
                    // 顯示C=0專用的Defect Rate Max控制項
                    document.getElementById('c0-defect-rate-control').style.display = 'flex';
                    // 新增：自動根據現有輸入值查詢並重現圖表與結果
                    setTimeout(() => { doC0Query(); }, 0);
                }
                
                updateChart();
            }

            // --- 主更新函數 ---
            function updateChart() {
                if (!ocChart) return;
                // [修改] 逆向查詢、C=0 與 Sampling Standard 有自己的繪圖邏輯
                if (currentMode === 'kaiyi') {
                    if (typeof performSSQuery === 'function') {
                        performSSQuery(true);
                    }
                    return;
                }
                if (currentMode !== 'reverse' && currentMode !== 'c0_plan') {
                    ocChart.data.datasets = [];
                    ocChart.options.plugins.annotation.annotations = {};
                    if (currentMode === 'distribution') {
                        ocChart.options.plugins.title.text = 'Comparison of Acceptance Probability Distributions';
                        updateDistributionChart();
                    } else if (currentMode === 'plan') {
                        ocChart.options.plugins.title.text = 'Comparison of Sampling Plans';
                        updatePlanComparisonChart();
                    } else {
                        ocChart.options.plugins.title.text = '';
                    }
                    ocChart.update();
                }
            }

            // --- 分配比較模式的繪圖邏輯 ---
            function updateDistributionChart() {
                let N_lot = distLotSizeInput.value === "" ? 10000 : parseInt(distLotSizeInput.value);
                let n = distNInput.value === "" ? 500 : parseInt(distNInput.value);
                let c = distCInput.value === "" ? 3 : parseInt(distCInput.value);
                let xAxisMaxPercent = distXAxisMaxInput.value === "" ? 2 : parseFloat(distXAxisMaxInput.value);

                ocChart.options.scales.x.max = xAxisMaxPercent;
                const pValues = generatePValues(xAxisMaxPercent);
    
                ocChart.data.datasets = [];
                if (showHypergeometricCheckbox.checked) {
                    const data = getOCData({ n, c, N: N_lot, distType: 'Hypergeometric' }, pValues);
                    ocChart.data.datasets.push({ label: `Hypergeometric`, data: data, borderColor: `rgba(231,76,60,0.9)`, backgroundColor: `rgba(231,76,60,0.6)`, borderWidth: 3, pointRadius: 0, tension: 0.1 });
                }
                if (showBinomialCheckbox.checked) {
                    const data = getOCData({ n, c }, pValues);
                    ocChart.data.datasets.push({ label: `Binomial`, data: data, borderColor: `rgba(241,196,15,1)`, backgroundColor: `rgba(241,196,15,0.33)`, borderWidth: 2, pointRadius: 0, tension: 0.1 });
                }
                if (showPoissonCheckbox.checked) {
                    const data = getOCData({ n, c, distType: 'Poisson' }, pValues);
                    ocChart.data.datasets.push({ label: `Poisson`, data: data, borderColor: `rgba(255,255,255,0.95)`, backgroundColor: `rgba(255,255,255,0.2)`, borderDash: [5, 5], borderWidth: 2, pointRadius: 0, tension: 0.1 });
                }
            }

            // --- 計畫比較模式的繪圖邏輯 ---
            function updatePlanComparisonChart() {
                let xAxisMaxPercent = planXAxisMaxInput.value === "" ? 2 : parseFloat(planXAxisMaxInput.value);
                ocChart.options.scales.x.max = xAxisMaxPercent;
                const pValues = generatePValues(xAxisMaxPercent);
                ocChart.data.datasets = [];
                const annotations = {};
                samplingPlans.forEach((plan, idx) => {
                    const dataPoints = pValues.map(p => ({ x: p * 100, y: jStat.binomial.cdf(plan.c, plan.n, p) }));
                    ocChart.data.datasets.push({ label: plan.label, data: dataPoints, borderColor: plan.color, backgroundColor: `${plan.color}33`, borderWidth: 2, pointRadius: 0, tension: 0.1 });
                    if (plan.aql !== null) {
                        const paAtAql = jStat.binomial.cdf(plan.c, plan.n, plan.aql);
                        const aqlX = plan.aql * 100;
                        if (aqlX <= xAxisMaxPercent) {
                            ocChart.data.datasets.push({ type: 'scatter', label: `AQL for ${plan.label}`, data: [{ x: aqlX, y: paAtAql }], backgroundColor: plan.color, borderColor: 'white', borderWidth: 2, radius: 6, hoverRadius: 8 });
                            annotations[`aqlLabel${idx}`] = {
                                type: 'label',
                                xValue: aqlX,
                                yValue: paAtAql,
                                backgroundColor: hexOrRgbaToRgba(plan.color, 0.5),
                                color: '#fff',
                                font: { size: 12, weight: 'bold' },
                                content: `${plan.label} (${aqlX.toFixed(2)}%, ${(paAtAql*100).toFixed(2)}%)`,
                                xAdjust: 0,
                                yAdjust: 24,
                                textAlign: 'left',
                                padding: {top: 6, right: 14, bottom: 6, left: 14}
                            };
                        }
                    }
                });
                ocChart.options.plugins.annotation.annotations = annotations;
                ocChart.update();
                updatePlanListView();
            }
            
            function updatePlanListView() {
                planList.innerHTML = '';
                samplingPlans.forEach((plan, index) => {
                    const li = document.createElement('li');
                    li.className = 'plan-item';
                    li.style.borderLeftColor = plan.color;
                    const aqlText = plan.aql !== null ? `AQL=${(plan.aql * 100).toFixed(2)}%` : 'No AQL';
                    li.innerHTML = `<span>${plan.label}: n=${plan.n}, c=${plan.c}, ${aqlText}</span><button class="delete-btn" data-index="${index}">×</button>`;
                    planList.appendChild(li);
                });
            }

            // --- 事件監聽器 ---
            modeRadios.forEach(radio => radio.addEventListener('change', (e) => switchMode(e.target.value)));
            [distLotSizeInput, distNInput, distCInput, distXAxisMaxInput, showHypergeometricCheckbox, showBinomialCheckbox, showPoissonCheckbox].forEach(el => {
                // 監聽LTPD欄位
                el.addEventListener('input', () => {
                    if (currentMode === 'distribution') {
                        document.getElementById('dist-error-msg').textContent = '';
                        if (!validateDistributionInputs()) return;
                        updateChart();
                        ocChart.update();
                    }
                });
            });
            
            // 新增：監聽 Multiple Plan Comparison 模式的 Defect Rate Max 輸入
            planXAxisMaxInput.addEventListener('input', () => {
                if (currentMode === 'plan') {
                    updateChart();
                    ocChart.update();
                }
            });
            
            addPlanBtn.addEventListener('click', () => {
                if (!validatePlanInputs()) return;
                const n = parseInt(planNInput.value), c = parseInt(planCInput.value), aql_input = planAqlInput.value;
                let aql = null;
                if (aql_input.trim() !== '') {
                    const aql_percent = parseFloat(aql_input);
                    if (isNaN(aql_percent) || aql_percent < 0) { alert('Please enter a valid AQL value (must be a number and greater than or equal to 0).'); return; }
                    aql = aql_percent / 100;
                }
                if (isNaN(n) || isNaN(c) || n <= 0 || c < 0 || n < c) { alert('Please enter valid n and c values (n > 0, c >= 0, n >= c).'); return; }
                const label = planLabelInput.value.trim() || `Plan ${planCounter++}`;
                samplingPlans.push({ n, c, aql, label, color: planColors[samplingPlans.length % planColors.length] });
                planLabelInput.value = '';
                updateChart();
                ocChart.update();
            });

            clearAllBtn.addEventListener('click', () => { samplingPlans = []; planCounter = 1; updateChart(); ocChart.update(); });
            planList.addEventListener('click', (e) => { if (e.target.classList.contains('delete-btn')) { samplingPlans.splice(parseInt(e.target.dataset.index), 1); updateChart(); ocChart.update(); } });

            // [重新設計] C=0 抽樣計畫互動邏輯 - 逆向查詢（先選n，再顯示AQL）
            function populateNDropdown(lotSizeRange = null) {
                const availableSampleSizes = getAvailableSampleSizes(lotSizeRange);
                
                if (availableSampleSizes.length > 0) {
                    c0NSelect.innerHTML = availableSampleSizes.map(n => `<option value="${n}">${n}</option>`).join('');
                    c0NSelect.value = availableSampleSizes[0]; // 設定第一個可用值為預設值
                } else {
                    c0NSelect.innerHTML = '<option value="">-- No valid sample sizes --</option>';
                }
            }

            function drawC0PlanChartWithLQ(plan, lq, beta) {
                if (!ocChart || !plan) {
                    clearReverseOCChart();
                    return;
                }
                const { n, c } = plan;
                const xAxisMaxPercent = parseFloat(c0XAxisMaxInput.value) || 5;
                ocChart.options.scales.x.max = xAxisMaxPercent;
                const pValues = generatePValues(xAxisMaxPercent);
                // 使用二項式分配計算OC曲線
                const data = getOCData({ n, c }, pValues);
                ocChart.data.datasets = [{
                    label: `C=0 Plan (n=${n}, c=0)`,
                    data: data,
                    borderColor: '#2ecc71',
                    backgroundColor: hexOrRgbaToRgba('#2ecc71', 0.3),
                    borderWidth: 3,
                    pointRadius: 0,
                    tension: 0.1
                },
                // LQ點
                {
                    type: 'scatter',
                    label: 'LQ Point',
                    data: [{ x: lq * 100, y: beta }],
                    backgroundColor: '#e67e22',
                    borderColor: 'white',
                    borderWidth: 2,
                    radius: 7,
                    hoverRadius: 10,
                    showLine: false
                }
                ];
                // 標示LQ點的虛線與標籤
                ocChart.options.plugins.annotation.annotations = {
                    lqVLine: { type: 'line', xMin: lq * 100, xMax: lq * 100, borderColor: '#e67e22', borderWidth: 2, borderDash: [6, 6] },
                    lqHLine: { type: 'line', yMin: beta, yMax: beta, borderColor: '#e67e22', borderWidth: 2, borderDash: [6, 6] },
                    lqLabel: {
                        type: 'label',
                        xValue: lq * 100,
                        yValue: beta,
                        backgroundColor: 'rgba(230,126,34,0.5)',
                        color: '#fff',
                        font: { size: 12, weight: 'bold' },
                        content: `LQ (${(lq*100).toFixed(2)}%, ${(beta*100).toFixed(2)}%)`,
                        xAdjust: 0,
                        yAdjust: -28,
                        textAlign: 'left',
                        padding: {top: 6, right: 14, bottom: 6, left: 14}
                    }
                };
                ocChart.options.plugins.title.text = `C=0 Sampling Plan OC Curve`;
                ocChart.update();
            }

            // [新增] 批量區間下拉選單產生
            function populateLotSizeDropdown() {
                const lotSizeSelect = document.getElementById('c0_lot_size_select');
                lotSizeSelect.innerHTML = C0_SAMPLING_TABLE.map(row => {
                    const [min, max] = row.lot_range;
                    const label = (max === Infinity) ? `${min} and over` : `${min} ~ ${max}`;
                    return `<option value="${min},${max}">${label}</option>`;
                }).join('');
                lotSizeSelect.selectedIndex = 10;
                
                // 監聽 lot size 選擇變更，更新 sample size 下拉選單
                lotSizeSelect.addEventListener('change', function() {
                    const selectedLotSizeRange = this.value;
                    populateNDropdown(selectedLotSizeRange);
                    // 自動觸發查詢
                    doC0Query();
                });
                
                // 初始化時也要更新 sample size 下拉選單
                const initialLotSizeRange = lotSizeSelect.value;
                populateNDropdown(initialLotSizeRange);
            }
            populateLotSizeDropdown();

            // [重新設計] 逆向查詢邏輯（從n查AQL）
            function doC0Query() {
                c0Result.textContent = '';
                c0Error.textContent = '';
                c0LqInfo.textContent = '';

                const lotSizeSelect = document.getElementById('c0_lot_size_select');
                const selectedLotSizeRange = lotSizeSelect.value;
                const selectedN = parseInt(c0NSelect.value);

                if (!selectedLotSizeRange || isNaN(selectedN)) {
                    c0Error.textContent = 'Please select valid lot size range and sample size.';
                    clearReverseOCChart();
                    return;
                }

                // 使用逆向查詢找到對應的AQL
                const foundAQL = getC0AqlBySampleSize(selectedLotSizeRange, selectedN);

                if (foundAQL) {
                    c0Result.innerHTML = `<span style="color:#ffc107; font-size:1.3em; font-weight:bold;">AQL: ${foundAQL}%</span>`;
                    
                    // 自動推算LQ（LTPD）
                    let aqlVal = parseFloat(foundAQL) / 100;
                    let n = selectedN;
                    let lq = 2.3026 / n;
                    let lqPercent = (lq * 100).toFixed(2);
                    let lqAqlRatio = (lq / aqlVal).toFixed(2);
                    c0LqInfo.innerHTML = `Sampling Plan: <b>n=${selectedN}, c=0, Re=1</b><br>LTPD (LQ): <b>${lqPercent}%</b> (about <b>${lqAqlRatio}</b> times AQL, consumer risk β=10%)`;
                    drawC0PlanChartWithLQ({n: selectedN, c: 0}, lq, 0.1);
                } else {
                    c0Error.textContent = `No valid AQL found for the selected lot size range and sample size ${selectedN}.`;
                    clearReverseOCChart();
                }
            }

            // 3. 所有input/select變動時都呼叫doC0Query
            [c0LotSizeInput, c0NSelect, c0XAxisMaxInput].forEach(el => {
                el.addEventListener('input', doC0Query);
                el.addEventListener('change', doC0Query);
            });

            // 4. 頁面載入時自動查詢一次
            setTimeout(doC0Query, 0);

            // === 逆向數學推算功能 (REWRITTEN) ===
            const reverseMathPanel = document.getElementById('reverse-math-controls');
            const mathAqlInput = document.getElementById('math_aql_input');
            const mathCInput = document.getElementById('math_c_input');
            const mathNInput = document.getElementById('math_n_input');
            const mathNbigInput = document.getElementById('math_N_input');
            const reverseMathError = document.getElementById('reverse-math-error');
            const reverseMathResultWrapper = document.getElementById('reverse-math-result-wrapper');
            const mathChks = Array.from(document.querySelectorAll('.reverse-math-chk'));
            const reverseOcXAxisMaxInput = document.getElementById('reverse_oc_x_axis_max_input');

            function updateReverseInputDisabledState() {
                [mathAqlInput, mathCInput, mathNInput, mathNbigInput].forEach((el, i) => {
                    el.disabled = !mathChks[i].checked;
                    if (el.disabled) el.value = '';
                });
            }

            mathChks.forEach(chk => {
                chk.addEventListener('change', () => {
                    const checked = mathChks.filter(c => c.checked);
                    if (checked.length > 3) {
                        chk.checked = false;
                        return;
                    }
                    updateReverseInputDisabledState();
                    // 當有效的參數組合時自動查詢
                    if (currentMode === 'reverse' && checked.length === 3) {
                        setTimeout(() => { doReverseQuery(); }, 100);
                    }
                });
            });

            const paTarget = 0.95;
            function calcPa(n, c, aql, N) {
                if (!N || n / N < 0.1) {
                    if (c < 0 || n <= 0 || c >= n || aql < 0 || aql > 1) {
                        return { pa: NaN, type: 'Binomial' };
                    }
                    return { pa: jStat.binomial.cdf(c, n, aql), type: 'Binomial' };
                } 
                else {
                    const K = Math.round(N * aql);
                    if (n > N || K > N || c < 0 || c > n || c > K || (n - c) > (N - K) || N <= 0) {
                        return { pa: NaN, type: 'Hypergeometric' };
                    }
                    return { pa: jStat.hypgeom.cdf(c, N, K, n), type: 'Hypergeometric' };
                }
            }

            reverseMathError.style.display = 'none';
            reverseMathResultWrapper.innerHTML = '';
            reverseSamplingPlans = [];
            clearReverseOCChart();

            const checkedIdx = mathChks.map((c, i) => c.checked ? i : -1).filter(i => i >= 0);
            if (checkedIdx.length !== 3) {
                reverseMathError.textContent = 'Please select exactly three parameters.';
                reverseMathError.style.display = 'block';
                return;
            }

            const vals = {
                aql: parseFloat(mathAqlInput.value) / 100,
                c: parseInt(mathCInput.value),
                n: parseInt(mathNInput.value),
                N: parseInt(mathNbigInput.value)
            };

            if (!validateReverseInputs(vals.n, vals.N, vals.c)) return;

            let plans = [];
            let searchParam = '';
            let noResultMsg = '';
            let validationError = false;

            if (!checkedIdx.includes(2)) { // Find n
                searchParam = 'n'; noResultMsg = 'No valid sample size (n) found.';
                if (isNaN(vals.aql) || isNaN(vals.c) || isNaN(vals.N)) { validationError = true; reverseMathError.textContent = 'Please enter valid AQL, acceptance number (c), and lot size (N).'; }
                else {
                    let n = vals.c + 1, nLimit = Math.min(vals.N, 10000), bestAbove = null, bestBelow = null;
                    while (n <= nLimit) {
                        const { pa, type } = calcPa(n, vals.c, vals.aql, vals.N);
                        if (!isNaN(pa)) {
                            if (pa >= paTarget) { if (!bestAbove || Math.abs(pa - paTarget) < Math.abs(bestAbove.pa - paTarget)) bestAbove = { n, pa, type }; }
                            else { if (!bestBelow || Math.abs(pa - paTarget) < Math.abs(bestBelow.pa - paTarget)) bestBelow = { n, pa, type }; }
                        }
                        n++;
                    }
                    if (bestAbove) plans.push({ ...vals, n: bestAbove.n, pa: bestAbove.pa, type: bestAbove.type });
                    if (bestBelow) plans.push({ ...vals, n: bestBelow.n, pa: bestBelow.pa, type: bestBelow.type });
                }
            } else if (!checkedIdx.includes(1)) { // Find c
                searchParam = 'c'; noResultMsg = 'No valid acceptance number (c) found.';
                if (isNaN(vals.aql) || isNaN(vals.n) || isNaN(vals.N)) { validationError = true; reverseMathError.textContent = 'Please enter valid AQL, sample size (n), and lot size (N).'; }
                else {
                    let c = 0, bestAbove = null, bestBelow = null;
                    while (c < vals.n) {
                        const { pa, type } = calcPa(vals.n, c, vals.aql, vals.N);
                        if (!isNaN(pa)) {
                            if (pa >= paTarget) { if (!bestAbove || Math.abs(pa - paTarget) < Math.abs(bestAbove.pa - paTarget)) bestAbove = { c, pa, type }; }
                            else { if (!bestBelow || Math.abs(pa - paTarget) < Math.abs(bestBelow.pa - paTarget)) bestBelow = { c, pa, type }; }
                        }
                        c++;
                    }
                    if (bestAbove) plans.push({ ...vals, c: bestAbove.c, pa: bestAbove.pa, type: bestAbove.type });
                    if (bestBelow) plans.push({ ...vals, c: bestBelow.c, pa: bestBelow.pa, type: bestBelow.type });
                }
            } else if (!checkedIdx.includes(0)) { // Find AQL
                searchParam = 'aql'; noResultMsg = 'No valid AQL found.';
                if (isNaN(vals.c) || isNaN(vals.n) || isNaN(vals.N)) { validationError = true; reverseMathError.textContent = 'Please enter valid acceptance number (c), sample size (n), and lot size (N).'; }
                else {
                    let bestAbove = null, bestBelow = null;
                    for (let i = 0; i <= 2000; i++) {
                        let aql = i / 2000;
                        const { pa, type } = calcPa(vals.n, vals.c, aql, vals.N);
                        if (!isNaN(pa)) {
                            if (pa >= paTarget) { if (!bestAbove || Math.abs(pa - paTarget) < Math.abs(bestAbove.pa - paTarget)) bestAbove = { aql, pa, type }; }
                            else { if (!bestBelow || Math.abs(pa - paTarget) < Math.abs(bestBelow.pa - paTarget)) bestBelow = { aql, pa, type }; }
                        }
                    }
                    if (bestAbove) plans.push({ ...vals, aql: bestAbove.aql, pa: bestAbove.pa, type: bestAbove.type });
                    if (bestBelow) plans.push({ ...vals, aql: bestBelow.aql, pa: bestBelow.pa, type: bestBelow.type });
                }
            } else if (!checkedIdx.includes(3)) { // Find N
                searchParam = 'N'; noResultMsg = 'No valid lot size (N) found.';
                if (isNaN(vals.aql) || isNaN(vals.c) || isNaN(vals.n)) { validationError = true; reverseMathError.textContent = 'Please enter valid AQL, acceptance number (c), and sample size (n).'; }
                else {
                    let bestAbove = null, bestBelow = null, Nmin = vals.n, Nmax = 1000000;
                    for (let N = Nmin; N <= Nmax; N += Math.max(1, Math.floor((Nmax - Nmin) / 2000))) {
                        const { pa, type } = calcPa(vals.n, vals.c, vals.aql, N);
                        if (!isNaN(pa)) {
                            if (pa >= paTarget) { if (!bestAbove || Math.abs(pa - paTarget) < Math.abs(bestAbove.pa - paTarget)) bestAbove = { N, pa, type }; }
                            else { if (!bestBelow || Math.abs(pa - paTarget) < Math.abs(bestBelow.pa - paTarget)) bestBelow = { N, pa, type }; }
                        }
                    }
                    if (bestAbove) plans.push({ ...vals, N: bestAbove.N, pa: bestAbove.pa, type: bestAbove.type });
                    if (bestBelow) plans.push({ ...vals, N: bestBelow.N, pa: bestBelow.pa, type: bestBelow.type });
                }
            }

            if (validationError) {
                reverseMathError.style.display = 'block';
                return;
            }

            if (plans.length > 0) {
                let html = '';
                const resultLabels = { n: 'Sample size n', c: 'Acceptance number c', aql: 'AQL', N: 'Lot size N' };
                plans.forEach((plan, idx) => {
                    let valText = searchParam === 'aql' ? `${(plan[searchParam]*100).toFixed(3)}%` : plan[searchParam];
                    html += `<div style='margin-bottom:8px;'><button type='button' class='reverse-select-btn' data-idx='${idx}'>Plan${idx + 1}</button> ${resultLabels[searchParam]}=<b>${valText}</b>，Pa=${(plan.pa * 100).toFixed(2)}%，${plan.type}</div>`;
                });
                reverseMathResultWrapper.innerHTML = html;
                reverseSamplingPlans = plans.map(p => ({ ...p, distType: p.type }));
                // 不再自動顯示所有圖表，只有在點擊按鈕時才顯示
                clearReverseOCChart();

                document.querySelectorAll('.reverse-select-btn').forEach(btn => {
                    btn.onclick = function() {
                        document.querySelectorAll('.reverse-select-btn').forEach(b => b.classList.remove('highlighted'));
                        this.classList.add('highlighted');
                        const idx = parseInt(this.getAttribute('data-idx'));
                        const selectedPlan = reverseSamplingPlans[idx];
                        fillReverseInputs(selectedPlan.aql, selectedPlan.c, selectedPlan.n, selectedPlan.N);
                        drawReverseOCChartMulti(reverseSamplingPlans, idx);
                    };
                });
            } else {
                reverseMathError.textContent = noResultMsg;
                reverseMathError.style.display = 'block';
            }

            function clearReverseOCChart() {
                if (ocChart) {
                    ocChart.data.datasets = [];
                    ocChart.options.plugins.annotation.annotations = {};
                    ocChart.options.plugins.title.text = '';
                    ocChart.update();
                }
            }

            function drawReverseOCChartMulti(plans, highlightIdx = -1) {
                if (!ocChart) return;
                let xAxisMaxPercent = parseFloat(reverseOcXAxisMaxInput.value) || 5;
                ocChart.options.scales.x.max = xAxisMaxPercent;
                const pValues = generatePValues(xAxisMaxPercent);
                const colors = ['#1783FF', '#e74c3c'];
                ocChart.data.datasets = [];
                const annotations = {};

                // 如果指定了highlightIdx，只顯示該計畫；否則不顯示任何計畫
                if (highlightIdx >= 0 && highlightIdx < plans.length) {
                    const plan = plans[highlightIdx];
                    const idx = highlightIdx;
                    let data = getOCData(plan, pValues);
                    
                    ocChart.data.datasets.push({
                        label: `Plan ${idx+1} (n=${plan.n}, c=${plan.c})`, data: data, borderColor: colors[idx],
                        backgroundColor: hexOrRgbaToRgba(colors[idx], 0.8), borderWidth: 3, pointRadius: 0, tension: 0.1
                    });

                    if (typeof plan.aql === 'number' && typeof plan.pa === 'number') {
                        const aqlX = plan.aql * 100;
                        ocChart.data.datasets.push({
                            type: 'scatter',
                            label: `AQL Point - Plan ${idx+1}`,
                            data: [{ x: aqlX, y: plan.pa }],
                            backgroundColor: colors[idx],
                            borderColor: '#fff',
                            borderWidth: 2,
                            radius: 7,
                            hoverRadius: 10
                        });
                        annotations[`aqlVLine${idx}`] = { type: 'line', xMin: aqlX, xMax: aqlX, borderColor: colors[idx], borderWidth: 2, borderDash: [6, 6] };
                        annotations[`aqlHLine${idx}`] = { type: 'line', yMin: plan.pa, yMax: plan.pa, borderColor: colors[idx], borderWidth: 2, borderDash: [6, 6] };
                        annotations[`aqlLabel${idx}`] = {
                            type: 'label',
                            xValue: aqlX,
                            yValue: plan.pa,
                            backgroundColor: hexOrRgbaToRgba(colors[idx], 0.9), //標籤的背景色
                            color: '#FFD700', //標籤的字體顏色
                            font: { size: 12, weight: 'bold' }, //標籤的字體大小與粗細
                            content: `★ Plan${idx+1} (${aqlX.toFixed(2)}%, ${(plan.pa*100).toFixed(2)}%) ★`, //標籤的內容
                            xAdjust: 100, //標籤的x軸偏移量
                            yAdjust: 0, //標籤的y軸偏移量
                            textAlign: 'left',
                            padding: {top: 6, right: 14, bottom: 6, left: 14} //標籤的內部間距
                        };
                    }
                }
                
                ocChart.options.plugins.annotation.annotations = annotations;
                ocChart.options.plugins.title.text = highlightIdx >= 0 ? `OC Curve - Plan ${highlightIdx + 1} (Reverse Sampling Plan Query)` : 'OC Curve (Reverse Sampling Plan Query)';
                ocChart.update();
            }

            function fillReverseInputs(aql, c, n, N) {
                [mathAqlInput, mathCInput, mathNInput, mathNbigInput].forEach(el => { el.style.color = ''; });
                if (!mathChks[0].checked && typeof aql === 'number' && !isNaN(aql)) { mathAqlInput.value = (aql * 100).toFixed(3); mathAqlInput.style.color = 'red'; }
                if (!mathChks[1].checked && typeof c === 'number' && !isNaN(c)) { mathCInput.value = c; mathCInput.style.color = 'red'; }
                if (!mathChks[2].checked && typeof n === 'number' && !isNaN(n)) { mathNInput.value = n; mathNInput.style.color = 'red'; }
                if (!mathChks[3].checked && typeof N === 'number' && !isNaN(N)) { mathNbigInput.value = N; mathNbigInput.style.color = 'red'; }
            }

            // --- 初始啟動 ---
            initializeChart();
            populateNDropdown(); // [新增] 初始化C=0的AQL下拉選單
            updateReverseInputDisabledState(); 
            switchMode('distribution');

            reverseOcXAxisMaxInput.addEventListener('input', function() {
                if (currentMode === 'reverse' && reverseSamplingPlans.length > 0) {
                    const highlightedButton = document.querySelector('.reverse-select-btn.highlighted');
                    if (highlightedButton) {
                        const highlightIdx = parseInt(highlightedButton.dataset.idx);
                        drawReverseOCChartMulti(reverseSamplingPlans, highlightIdx);
                    } else {
                        // 如果沒有選擇任何計畫，則清空圖表
                        clearReverseOCChart();
                    }
                }
            });

            // 移除舊版 Table 分頁圖片切換與 Code Letters/Master Tables 切換，統一使用 Sampling Standard 控制面板

            // 驗證函數
            function validateDistributionInputs() {
                const N = parseInt(document.getElementById('dist_lot_size_input').value);
                const n = parseInt(document.getElementById('dist_n_input').value);
                const c = parseInt(document.getElementById('dist_c_input').value);
                const errorMsg = document.getElementById('dist-error-msg');
                errorMsg.textContent = '';
                if (isNaN(n) || isNaN(c) || isNaN(N)) return false;
                if (n > N) {
                    errorMsg.textContent = 'Sample size (n) cannot be greater than lot size (N)!'
                    return false;
                }
                if (c > n) {
                    errorMsg.textContent = 'Acceptance number (c) cannot be greater than sample size (n)!'
                    return false;
                }
                return true;
            }
            function validatePlanInputs() {
                const n = parseInt(planNInput.value);
                const c = parseInt(planCInput.value);
                if (c > n) {
                    alert('Acceptance number (c) cannot be greater than sample size (n)!');
                    return false;
                }
                return true;
            }
            function validateReverseInputs(n, N, c) {
                if (n > N) {
                    reverseMathError.textContent = 'Sample size (n) cannot be greater than lot size (N)!'
                    reverseMathError.style.display = 'block';
                    return false;
                }
                if (c > n) {
                    reverseMathError.textContent = 'Acceptance number (c) cannot be greater than sample size (n)!'
                    reverseMathError.style.display = 'block';
                    return false;
                }
                return true;
            }

            // 匯出功能
            document.getElementById('btn-export-png').onclick = function() {
                const canvas = document.getElementById('ocChart');
                if (!canvas) return;

                // 獲取原始圖表的渲染尺寸
                const w = canvas.width;
                const h = canvas.height;

                // --- 設定匯出參數 ---
                // 1. 邊界 (padding)：在圖表周圍增加的留白，單位為像素
                const paddingLeft = 100;
                const paddingRight = 100;
                const paddingTop = 80;
                const paddingBottom = 40;

                // 2. 解析度倍率 (scale)：最終圖片的放大倍數，2 或 3 可提供極佳品質
                const scale = 2;
                
                // --- 計算最終匯出尺寸 ---
                const exportWidth = (w + paddingLeft + paddingRight) * scale;
                const exportHeight = (h + paddingTop + paddingBottom) * scale;

                // --- 建立暫時的高解析度畫布 ---
                const tmpCanvas = document.createElement('canvas');
                tmpCanvas.width = exportWidth;
                tmpCanvas.height = exportHeight;
                const ctx = tmpCanvas.getContext('2d');

                // --- 繪製背景與圖表 ---
                // 1. 填滿背景色 (確保與網頁背景色一致)
                ctx.fillStyle = '#05131c'; // Single_Sampling_Plan.html 的圖表區背景色
                ctx.fillRect(0, 0, exportWidth, exportHeight);

                // 2. 將原始圖表以高解析度繪製到暫時畫布上
                //    使用 drawImage 的 9 參數版本來實現縮放與定位
                ctx.drawImage(
                    canvas, // 來源影像
                    0, 0, w, h, // 來源影像的擷取區域 (整個圖表)
                    paddingLeft * scale, paddingTop * scale, w * scale, h * scale // 在目標畫布上繪製的區域 (放大並留出邊界)
                );

                // --- 觸發下載 ---
                const link = document.createElement('a');
                link.href = tmpCanvas.toDataURL('image/png'); // 將高品質畫布轉換為圖片數據
                link.download = `oc_chart_${currentMode}_high_res.png`; // 建議使用新檔名
                link.click();
            };
            document.getElementById('btn-export-csv').onclick = function() {
                let csv = 'label,x_defect_rate_percent,y_acceptance_prob\n';
                if (ocChart && ocChart.data && ocChart.data.datasets) {
                    ocChart.data.datasets.forEach(ds => {
                        if (Array.isArray(ds.data) && !ds.label.toLowerCase().includes('aql')) {
                            ds.data.forEach(point => {
                                if (typeof point.x !== 'undefined' && typeof point.y !== 'undefined') {
                                    csv += `${ds.label},${point.x},${point.y}\n`;
                                }
                            });
                        }
                    });
                }
                const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `oc_data_${currentMode}.csv`;
                link.click();
            };

            // 1. 抽出查詢主邏輯
            function doReverseQuery() {
                reverseMathError.style.display = 'none';
                reverseMathResultWrapper.innerHTML = '';
                reverseSamplingPlans = [];
                clearReverseOCChart();

                const checkedIdx = mathChks.map((c, i) => c.checked ? i : -1).filter(i => i >= 0);
                if (checkedIdx.length !== 3) {
                    reverseMathError.textContent = 'Please select exactly three parameters.';
                    reverseMathError.style.display = 'block';
                    return;
                }

                const vals = {
                    aql: parseFloat(mathAqlInput.value) / 100,
                    c: parseInt(mathCInput.value),
                    n: parseInt(mathNInput.value),
                    N: parseInt(mathNbigInput.value)
                };

                if (!validateReverseInputs(vals.n, vals.N, vals.c)) return;

                let plans = [];
                let searchParam = '';
                let noResultMsg = '';
                let validationError = false;

                if (!checkedIdx.includes(2)) { // Find n
                    searchParam = 'n'; noResultMsg = 'No valid sample size (n) found.';
                    if (isNaN(vals.aql) || isNaN(vals.c) || isNaN(vals.N)) { validationError = true; reverseMathError.textContent = 'Please enter valid AQL, acceptance number (c), and lot size (N).'; }
                    else {
                        let n = vals.c + 1, nLimit = Math.min(vals.N, 10000), bestAbove = null, bestBelow = null;
                        while (n <= nLimit) {
                            const { pa, type } = calcPa(n, vals.c, vals.aql, vals.N);
                            if (!isNaN(pa)) {
                                if (pa >= paTarget) { if (!bestAbove || Math.abs(pa - paTarget) < Math.abs(bestAbove.pa - paTarget)) bestAbove = { n, pa, type }; }
                                else { if (!bestBelow || Math.abs(pa - paTarget) < Math.abs(bestBelow.pa - paTarget)) bestBelow = { n, pa, type }; }
                            }
                            n++;
                        }
                        if (bestAbove) plans.push({ ...vals, n: bestAbove.n, pa: bestAbove.pa, type: bestAbove.type });
                        if (bestBelow) plans.push({ ...vals, n: bestBelow.n, pa: bestBelow.pa, type: bestBelow.type });
                    }
                } else if (!checkedIdx.includes(1)) { // Find c
                    searchParam = 'c'; noResultMsg = 'No valid acceptance number (c) found.';
                    if (isNaN(vals.aql) || isNaN(vals.n) || isNaN(vals.N)) { validationError = true; reverseMathError.textContent = 'Please enter valid AQL, sample size (n), and lot size (N).'; }
                    else {
                        let c = 0, bestAbove = null, bestBelow = null;
                        // 限制搜索範圍以提高效能：acceptance number 通常不會超過樣本數的20%或100（取較小者）
                        const maxC = Math.min(vals.n, Math.max(100, Math.floor(vals.n * 0.2)));
                        while (c <= maxC) {
                            const { pa, type } = calcPa(vals.n, c, vals.aql, vals.N);
                            if (!isNaN(pa)) {
                                if (pa >= paTarget) { if (!bestAbove || Math.abs(pa - paTarget) < Math.abs(bestAbove.pa - paTarget)) bestAbove = { c, pa, type }; }
                                else { if (!bestBelow || Math.abs(pa - paTarget) < Math.abs(bestBelow.pa - paTarget)) bestBelow = { c, pa, type }; }
                            }
                            c++;
                            // 早期退出優化：如果已經找到合適的上下範圍結果，提早停止搜索
                            if (bestAbove && bestBelow && Math.abs(bestAbove.pa - paTarget) < 0.01 && Math.abs(bestBelow.pa - paTarget) < 0.01) {
                                break;
                            }
                        }
                        if (bestAbove) plans.push({ ...vals, c: bestAbove.c, pa: bestAbove.pa, type: bestAbove.type });
                        if (bestBelow) plans.push({ ...vals, c: bestBelow.c, pa: bestBelow.pa, type: bestBelow.type });
                    }
                } else if (!checkedIdx.includes(0)) { // Find AQL
                    searchParam = 'aql'; noResultMsg = 'No valid AQL found.';
                    if (isNaN(vals.c) || isNaN(vals.n) || isNaN(vals.N)) { validationError = true; reverseMathError.textContent = 'Please enter valid acceptance number (c), sample size (n), and lot size (N).'; }
                    else {
                        let bestAbove = null, bestBelow = null;
                        for (let i = 0; i <= 2000; i++) {
                            let aql = i / 2000;
                            const { pa, type } = calcPa(vals.n, vals.c, aql, vals.N);
                            if (!isNaN(pa)) {
                                if (pa >= paTarget) { if (!bestAbove || Math.abs(pa - paTarget) < Math.abs(bestAbove.pa - paTarget)) bestAbove = { aql, pa, type }; }
                                else { if (!bestBelow || Math.abs(pa - paTarget) < Math.abs(bestBelow.pa - paTarget)) bestBelow = { aql, pa, type }; }
                            }
                        }
                        if (bestAbove) plans.push({ ...vals, aql: bestAbove.aql, pa: bestAbove.pa, type: bestAbove.type });
                        if (bestBelow) plans.push({ ...vals, aql: bestBelow.aql, pa: bestBelow.pa, type: bestBelow.type });
                    }
                } else if (!checkedIdx.includes(3)) { // Find N
                    searchParam = 'N'; noResultMsg = 'No valid lot size (N) found.';
                    if (isNaN(vals.aql) || isNaN(vals.c) || isNaN(vals.n)) { validationError = true; reverseMathError.textContent = 'Please enter valid AQL, acceptance number (c), and sample size (n).'; }
                    else {
                        let bestAbove = null, bestBelow = null, Nmin = vals.n, Nmax = 1000000;
                        for (let N = Nmin; N <= Nmax; N += Math.max(1, Math.floor((Nmax - Nmin) / 2000))) {
                            const { pa, type } = calcPa(vals.n, vals.c, vals.aql, N);
                            if (!isNaN(pa)) {
                                if (pa >= paTarget) { if (!bestAbove || Math.abs(pa - paTarget) < Math.abs(bestAbove.pa - paTarget)) bestAbove = { N, pa, type }; }
                                else { if (!bestBelow || Math.abs(pa - paTarget) < Math.abs(bestBelow.pa - paTarget)) bestBelow = { N, pa, type }; }
                            }
                        }
                        if (bestAbove) plans.push({ ...vals, N: bestAbove.N, pa: bestAbove.pa, type: bestAbove.type });
                        if (bestBelow) plans.push({ ...vals, N: bestBelow.N, pa: bestBelow.pa, type: bestBelow.type });
                    }
                }

                if (validationError) {
                    reverseMathError.style.display = 'block';
                    return;
                }

                if (plans.length > 0) {
                    let html = '';
                    const resultLabels = { n: 'Sample size n', c: 'Acceptance number c', aql: 'AQL', N: 'Lot size N' };
                    plans.forEach((plan, idx) => {
                        let valText = searchParam === 'aql' ? `${(plan[searchParam]*100).toFixed(3)}%` : plan[searchParam];
                        html += `<div style='margin-bottom:8px;'><button type='button' class='reverse-select-btn' data-idx='${idx}'>Plan${idx + 1}</button> ${resultLabels[searchParam]}=<b>${valText}</b>，Pa=${(plan.pa * 100).toFixed(2)}%，${plan.type}</div>`;
                    });
                    reverseMathResultWrapper.innerHTML = html;
                    reverseSamplingPlans = plans.map(p => ({ ...p, distType: p.type }));
                    // 不再自動顯示所有圖表，只有在點擊按鈕時才顯示
                    clearReverseOCChart();

                    document.querySelectorAll('.reverse-select-btn').forEach(btn => {
                        btn.onclick = function() {
                            document.querySelectorAll('.reverse-select-btn').forEach(b => b.classList.remove('highlighted'));
                            this.classList.add('highlighted');
                            const idx = parseInt(this.getAttribute('data-idx'));
                            const selectedPlan = reverseSamplingPlans[idx];
                            fillReverseInputs(selectedPlan.aql, selectedPlan.c, selectedPlan.n, selectedPlan.N);
                            drawReverseOCChartMulti(reverseSamplingPlans, idx);
                        };
                    });
                } else {
                    reverseMathError.textContent = noResultMsg;
                    reverseMathError.style.display = 'block';
                }
            }

            // 2. 將所有原本呼叫 reverseMathQueryBtn.click() 的地方改為 doReverseQuery()
            [mathAqlInput, mathCInput, mathNInput, mathNbigInput].forEach(input => {
                input.addEventListener('input', () => {
                    if (currentMode === 'reverse') {
                        doReverseQuery();
                    }
                });
            });

            // [新增] 匯出至多計畫比較功能
            c0ExportToPlanBtn.addEventListener('click', function() {
                // 取得目前C=0查表的n, c=0, AQL, x軸上限
                const lotSizeSelect = c0LotSizeInput;
                const [min, max] = lotSizeSelect.value.split(',').map(Number);
                const lotSize = (max === Infinity) ? min : Math.round((min + max) / 2);
                const selectedN = parseInt(c0NSelect.value);
                const xAxisMax = c0XAxisMaxInput.value;
                
                // 找到對應的AQL
                let foundAQL = null;
                for (const row of C0_SAMPLING_TABLE) {
                    const [rowMin, rowMax] = row.lot_range;
                    if (lotSize >= rowMin && lotSize <= rowMax) {
                        for (const [aql, n] of Object.entries(row.samples)) {
                            if (n === selectedN) {
                                foundAQL = aql;
                                break;
                            }
                        }
                        break;
                    }
                }
                
                if (foundAQL && !isNaN(selectedN)) {
                    planNInput.value = selectedN;
                    planCInput.value = 0;
                    planAqlInput.value = foundAQL;
                    planXAxisMaxInput.value = xAxisMax;
                    // 自動切換到多計畫比較模式
                    document.getElementById('mode-plan').checked = true;
                    switchMode('plan');
                } else {
                    alert('Unable to export current C=0 table parameters: No valid plan found');
                }
            });

            // === AQL查表工具邏輯 (已整合與修正) ===
            (function(){
            // ===== 數據庫 =====
            const codeLetterTable = [
                { min: 2, max: 8,     levels: { 'I': 'A', 'II': 'A', 'III': 'B', 'S-1': 'A', 'S-2': 'A', 'S-3': 'A', 'S-4': 'A' } },
                { min: 9, max: 15,    levels: { 'I': 'A', 'II': 'B', 'III': 'C', 'S-1': 'A', 'S-2': 'A', 'S-3': 'A', 'S-4': 'A' } },
                { min: 16, max: 25,   levels: { 'I': 'B', 'II': 'C', 'III': 'D', 'S-1': 'A', 'S-2': 'A', 'S-3': 'B', 'S-4': 'B' } },
                { min: 26, max: 50,   levels: { 'I': 'C', 'II': 'D', 'III': 'E', 'S-1': 'A', 'S-2': 'B', 'S-3': 'B', 'S-4': 'C' } },
                { min: 51, max: 90,   levels: { 'I': 'C', 'II': 'E', 'III': 'F', 'S-1': 'B', 'S-2': 'B', 'S-3': 'C', 'S-4': 'C' } },
                { min: 91, max: 150,  levels: { 'I': 'D', 'II': 'F', 'III': 'G', 'S-1': 'B', 'S-2': 'B', 'S-3': 'C', 'S-4': 'D' } },
                { min: 151, max: 280, levels: { 'I': 'E', 'II': 'G', 'III': 'H', 'S-1': 'B', 'S-2': 'C', 'S-3': 'D', 'S-4': 'E' } },
                { min: 281, max: 500, levels: { 'I': 'F', 'II': 'H', 'III': 'J', 'S-1': 'B', 'S-2': 'C', 'S-3': 'D', 'S-4': 'E' } },
                { min: 501, max: 1200, levels: { 'I': 'G', 'II': 'J', 'III': 'K', 'S-1': 'C', 'S-2': 'C', 'S-3': 'E', 'S-4': 'F' } },
                { min: 1201, max: 3200, levels: { 'I': 'H', 'II': 'K', 'III': 'L', 'S-1': 'C', 'S-2': 'D', 'S-3': 'E', 'S-4': 'G' } },
                { min: 3201, max: 10000, levels: { 'I': 'J', 'II': 'L', 'III': 'M', 'S-1': 'C', 'S-2': 'D', 'S-3': 'F', 'S-4': 'G' } },
                { min: 10001, max: 35000, levels: { 'I': 'K', 'II': 'M', 'III': 'N', 'S-1': 'C', 'S-2': 'D', 'S-3': 'F', 'S-4': 'H' } },
                { min: 35001, max: 150000, levels: { 'I': 'L', 'II': 'N', 'III': 'P', 'S-1': 'D', 'S-2': 'E', 'S-3': 'G', 'S-4': 'J' } },
                { min: 150001, max: 500000, levels: { 'I': 'M', 'II': 'P', 'III': 'Q', 'S-1': 'D', 'S-2': 'E', 'S-3': 'G', 'S-4': 'J' } },
                { min: 500001, max: null, levels: { 'I': 'N', 'II': 'Q', 'III': 'R', 'S-1': 'D', 'S-2': 'E', 'S-3': 'H', 'S-4': 'K' } }
            ];
            const aqlLevels = ['0.010', '0.015', '0.025', '0.040', '0.065', '0.10', '0.15', '0.25', '0.40', '0.65', '1.0', '1.5', '2.5', '4.0', '6.5', '10', '15', '25', '40', '65', '100', '150', '250', '400', '650', '1000'];

            // Normal Inspection Data
            const codeLettersOrder_normal = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'J', 'K', 'L', 'M', 'N', 'P', 'Q', 'R'];
			
            const normal_sampleSizes = {'A': 2, 'B': 3, 'C': 5, 'D': 8, 'E': 13, 'F': 20, 'G': 32, 'H': 50, 'J': 80, 'K': 125, 'L': 200, 'M': 315, 'N': 500, 'P': 800, 'Q': 1250, 'R': 2000};
			
			const normal_rawMasterTableData = {
				'A': { '0.010': 'down', '0.015': 'down', '0.025': 'down', '0.040': 'down', '0.065': 'down', '0.10': 'down', '0.15': 'down', '0.25': 'down', '0.40': 'down', '0.65': 'down', '1.0': 'down', '1.5': 'down', '2.5': 'down', '4.0': 'down', '6.5': 0     , '10': 'down', '15': 'down', '25': 1     , '40': 2     , '65': 3     , '100': 5     , '150': 7     , '250': 10    , '400': 14    , '650': 21    , '1000': 30    },
				'B': { '0.010': 'down', '0.015': 'down', '0.025': 'down', '0.040': 'down', '0.065': 'down', '0.10': 'down', '0.15': 'down', '0.25': 'down', '0.40': 'down', '0.65': 'down', '1.0': 'down', '1.5': 'down', '2.5': 'down', '4.0': 0     , '6.5': 'up'  , '10': 'down', '15': 1     , '25': 2     , '40': 3     , '65': 5     , '100': 7     , '150': 10    , '250': 14    , '400': 21    , '650': 30    , '1000': 44    },
				'C': { '0.010': 'down', '0.015': 'down', '0.025': 'down', '0.040': 'down', '0.065': 'down', '0.10': 'down', '0.15': 'down', '0.25': 'down', '0.40': 'down', '0.65': 'down', '1.0': 'down', '1.5': 'down', '2.5': 0     , '4.0': 'up'  , '6.5': 'down', '10': 1     , '15': 2     , '25': 3     , '40': 5     , '65': 7     , '100': 10    , '150': 14    , '250': 21    , '400': 30    , '650': 44    , '1000': 'up'  },
				'D': { '0.010': 'down', '0.015': 'down', '0.025': 'down', '0.040': 'down', '0.065': 'down', '0.10': 'down', '0.15': 'down', '0.25': 'down', '0.40': 'down', '0.65': 'down', '1.0': 'down', '1.5': 0     , '2.5': 'up'  , '4.0': 'down', '6.5': 1     , '10': 2     , '15': 3     , '25': 5     , '40': 7     , '65': 10    , '100': 14    , '150': 21    , '250': 30    , '400': 44    , '650': 'up'  , '1000': 'up'  },
				'E': { '0.010': 'down', '0.015': 'down', '0.025': 'down', '0.040': 'down', '0.065': 'down', '0.10': 'down', '0.15': 'down', '0.25': 'down', '0.40': 'down', '0.65': 'down', '1.0': 0     , '1.5': 'up'  , '2.5': 'down', '4.0': 1     , '6.5': 2     , '10': 3     , '15': 5     , '25': 7     , '40': 10    , '65': 14    , '100': 21    , '150': 30    , '250': 44    , '400': 'up'  , '650': 'up'  , '1000': 'up'  },
				'F': { '0.010': 'down', '0.015': 'down', '0.025': 'down', '0.040': 'down', '0.065': 'down', '0.10': 'down', '0.15': 'down', '0.25': 'down', '0.40': 'down', '0.65': 0     , '1.0': 'up'  , '1.5': 'down', '2.5': 1     , '4.0': 2     , '6.5': 3     , '10': 5     , '15': 7     , '25': 10    , '40': 14    , '65': 21    , '100': 'up'  , '150': 'up'  , '250': 'up'  , '400': 'up'  , '650': 'up'  , '1000': 'up'  },
				'G': { '0.010': 'down', '0.015': 'down', '0.015': 'down', '0.040': 'down', '0.065': 'down', '0.10': 'down', '0.15': 'down', '0.25': 'down', '0.40': 0     , '0.65': 'up'  , '1.0': 'down', '1.5': 1     , '2.5': 2     , '4.0': 3     , '6.5': 5     , '10': 7     , '15': 10    , '25': 14    , '40': 21    , '65': 'up'  , '100': 'up'  , '150': 'up'  , '250': 'up'  , '400': 'up'  , '650': 'up'  , '1000': 'up'  },
				'H': { '0.010': 'down', '0.015': 'down', '0.025': 'down', '0.040': 'down', '0.065': 'down', '0.10': 'down', '0.15': 'down', '0.25': 0     , '0.40': 'up'  , '0.65': 'down', '1.0': 1     , '1.5': 2     , '2.5': 3     , '4.0': 5     , '6.5': 7     , '10': 10    , '15': 14    , '25': 21    , '40': 'up'  , '65': 'up'  , '100': 'up'  , '150': 'up'  , '250': 'up'  , '400': 'up'  , '650': 'up'  , '1000': 'up'  },
				'J': { '0.010': 'down', '0.015': 'down', '0.025': 'down', '0.040': 'down', '0.065': 'down', '0.10': 'down', '0.15': 0     , '0.25': 'up'  , '0.40': 'down', '0.65': 1     , '1.0': 2     , '1.5': 3     , '2.5': 5     , '4.0': 7     , '6.5': 10    , '10': 14    , '15': 21    , '25': 'up'  , '40': 'up'  , '65': 'up'  , '100': 'up'  , '150': 'up'  , '250': 'up'  , '400': 'up'  , '650': 'up'  , '1000': 'up'  },
				'K': { '0.010': 'down', '0.015': 'down', '0.025': 'down', '0.040': 'down', '0.065': 'down', '0.10': 0     , '0.15': 'up'  , '0.25': 'down', '0.40': 1     , '0.65': 2     , '1.0': 3     , '1.5': 5     , '2.5': 7     , '4.0': 10    , '6.5': 14    , '10': 21    , '15': 'up'  , '25': 'up'  , '40': 'up'  , '65': 'up'  , '100': 'up'  , '150': 'up'  , '250': 'up'  , '400': 'up'  , '650': 'up'  , '1000': 'up'  },
				'L': { '0.010': 'down', '0.015': 'down', '0.025': 'down', '0.040': 'down', '0.065': 0     , '0.10': 'up'  , '0.15': 'down', '0.25': 1     , '0.40': 2     , '0.65': 3     , '1.0': 5     , '1.5': 7     , '2.5': 10    , '4.0': 14    , '6.5': 21    , '10': 'up'  , '15': 'up'  , '25': 'up'  , '40': 'up'  , '65': 'up'  , '100': 'up'  , '150': 'up'  , '250': 'up'  , '400': 'up'  , '650': 'up'  , '1000': 'up'  },
				'M': { '0.010': 'down', '0.015': 'down', '0.025': 'down', '0.040': 0     , '0.065': 'up'  , '0.10': 'down', '0.15': 1     , '0.25': 2     , '0.40': 3     , '0.65': 5     , '1.0': 7     , '1.5': 10    , '2.5': 14    , '4.0': 21    , '6.5': 'up'  , '10': 'up'  , '15': 'up'  , '25': 'up'  , '40': 'up'  , '65': 'up'  , '100': 'up'  , '150': 'up'  , '250': 'up'  , '400': 'up'  , '650': 'up'  , '1000': 'up'  },
				'N': { '0.010': 'down', '0.015': 'down', '0.025': 0     , '0.040': 'up'  , '0.065': 'down', '0.10': 1     , '0.15': 2     , '0.25': 3     , '0.40': 5     , '0.65': 7     , '1.0': 10    , '1.5': 14    , '2.5': 21    , '4.0': 'up'  , '6.5': 'up'  , '10': 'up'  , '15': 'up'  , '25': 'up'  , '40': 'up'  , '65': 'up'  , '100': 'up'  , '150': 'up'  , '250': 'up'  , '400': 'up'  , '650': 'up'  , '1000': 'up'  },
				'P': { '0.010': 'down', '0.015': 0     , '0.025': 'up'  , '0.040': 'down', '0.065': 1     , '0.10': 2     , '0.15': 3     , '0.25': 5     , '0.40': 7     , '0.65': 10    , '1.0': 14    , '1.5': 21    , '2.5': 'up'  , '4.0': 'up'  , '6.5': 'up'  , '10': 'up'  , '15': 'up'  , '25': 'up'  , '40': 'up'  , '65': 'up'  , '100': 'up'  , '150': 'up'  , '250': 'up'  , '400': 'up'  , '650': 'up'  , '1000': 'up'  },
				'Q': { '0.010': 0     , '0.015': 'up'  , '0.025': 'down', '0.040': 1     , '0.065': 2     , '0.10': 3     , '0.15': 5     , '0.25': 7     , '0.40': 10    , '0.65': 14    , '1.0': 21    , '1.5': 'up'  , '2.5': 'up'  , '4.0': 'up'  , '6.5': 'up'  , '10': 'up'  , '15': 'up'  , '25': 'up'  , '40': 'up'  , '65': 'up'  , '100': 'up'  , '150': 'up'  , '250': 'up'  , '400': 'up'  , '650': 'up'  , '1000': 'up'  },
				'R': { '0.010': 'up'  , '0.015': 'up'  , '0.025': 1     , '0.040': 2     , '0.065': 3     , '0.10': 5     , '0.15': 7     , '0.25': 10    , '0.40': 14    , '0.65': 21    , '1.0': 'up'  , '1.5': 'up'  , '2.5': 'up'  , '4.0': 'up'  , '6.5': 'up'  , '10': 'up'  , '15': 'up'  , '25': 'up'  , '40': 'up'  , '65': 'up'  , '100': 'up'  , '150': 'up'  , '250': 'up'  , '400': 'up'  , '650': 'up'  , '1000': 'up'  }
			};
            
            // Tightened Inspection Data
            const codeLettersOrder_tightened = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'J', 'K', 'L', 'M', 'N', 'P', 'Q', 'R', 'S'];
			
            const tightened_sampleSizes = {'A': 2, 'B': 3, 'C': 5, 'D': 8, 'E': 13, 'F': 20, 'G': 32, 'H': 50, 'J': 80, 'K': 125, 'L': 200, 'M': 315, 'N': 500, 'P': 800, 'Q': 1250, 'R': 2000, 'S': 3150};
			
			const tightened_rawMasterTableData = {
				'A': { '0.010': 'down', '0.015': 'down', '0.025': 'down', '0.040': 'down', '0.065': 'down', '0.10': 'down', '0.15': 'down', '0.25': 'down', '0.40': 'down', '0.65': 'down', '1.0': 'down', '1.5': 'down', '2.5': 'down', '4.0': 'down', '6.5': 'down', '10': 'down', '15': 'down', '25': 'down', '40': 1, '65': 2, '100': 3, '150': 5, '250': 8, '400': 12, '650': 18, '1000': 27 },
				'B': { '0.010': 'down', '0.015': 'down', '0.025': 'down', '0.040': 'down', '0.065': 'down', '0.10': 'down', '0.15': 'down', '0.25': 'down', '0.40': 'down', '0.65': 'down', '1.0': 'down', '1.5': 'down', '2.5': 'down', '4.0': 'down', '6.5': 0, '10': 'down', '15': 'down', '25': 1, '40': 2, '65': 3, '100': 5, '150': 8, '250': 12, '400': 18, '650': 27, '1000': 41 },
				'C': { '0.010': 'down', '0.015': 'down', '0.025': 'down', '0.040': 'down', '0.065': 'down', '0.10': 'down', '0.15': 'down', '0.25': 'down', '0.40': 'down', '0.65': 'down', '1.0': 'down', '1.5': 'down', '2.5': 'down', '4.0': 0, '6.5': 'down', '10': 'down', '15': 1, '25': 2, '40': 3, '65': 5, '100': 8, '150': 12, '250': 18, '400': 27, '650': 41, '1000': 'up' },
				'D': { '0.010': 'down', '0.015': 'down', '0.025': 'down', '0.040': 'down', '0.065': 'down', '0.10': 'down', '0.15': 'down', '0.25': 'down', '0.40': 'down', '0.65': 'down', '1.0': 'down', '1.5': 'down', '2.5': 0, '4.0': 'down', '6.5': 'down', '10': 1, '15': 2, '25': 3, '40': 5, '65': 8, '100': 12, '150': 18, '250': 27, '400': 41, '650': 'up', '1000': 'up' },
				'E': { '0.010': 'down', '0.015': 'down', '0.025': 'down', '0.040': 'down', '0.065': 'down', '0.10': 'down', '0.15': 'down', '0.25': 'down', '0.40': 'down', '0.65': 'down', '1.0': 'down', '1.5': 0, '2.5': 1, '4.0': 'down', '6.5': 1, '10': 2, '15': 3, '25': 5, '40': 8, '65': 12, '100': 18, '150': 27, '250': 41, '400': 'up', '650': 'up', '1000': 'up' },
				'F': { '0.010': 'down', '0.015': 'down', '0.025': 'down', '0.040': 'down', '0.065': 'down', '0.10': 'down', '0.15': 'down', '0.25': 'down', '0.40': 'down', '0.65': 'down', '1.0': 0, '1.5': 'down', '2.5': 'down', '4.0': 1, '6.5': 2, '10': 3, '15': 5, '25': 8, '40': 12, '65': 18, '100': 'up', '150': 'up', '250': 'up', '400': 'up', '650': 'up', '1000': 'up' },
				'G': { '0.010': 'down', '0.015': 'down', '0.015': 'down', '0.040': 'down', '0.065': 'down', '0.10': 'down', '0.15': 'down', '0.25': 'down', '0.40': 'down', '0.65': 0, '1.0': 'down', '1.5': 'down', '2.5': 1, '4.0': 2, '6.5': 3, '10': 5, '15': 8, '25': 12, '40': 18, '65': 'up', '100': 'up', '150': 'up', '250': 'up', '400': 'up', '650': 'up', '1000': 'up' },
				'H': { '0.010': 'down', '0.015': 'down', '0.025': 'down', '0.040': 'down', '0.065': 'down', '0.10': 'down', '0.15': 'down', '0.25': 'down', '0.40': 0, '0.65': 'down', '1.0': 'down', '1.5': 1, '2.5': 2, '4.0': 3, '6.5': 5, '10': 8, '15': 12, '25': 18, '40': 'up', '65': 'up', '100': 'up', '150': 'up', '250': 'up', '400': 'up', '650': 'up', '1000': 'up' },
				'J': { '0.010': 'down', '0.015': 'down', '0.025': 'down', '0.040': 'down', '0.065': 'down', '0.10': 'down', '0.15': 'down', '0.25': 0, '0.40': 'down', '0.65': 'down', '1.0': 1, '1.5': 2, '2.5': 3, '4.0': 5, '6.5': 8, '10': 12, '15': 18, '25': 'up', '40': 'up', '65': 'up', '100': 'up', '150': 'up', '250': 'up', '400': 'up', '650': 'up', '1000': 'up' },
				'K': { '0.010': 'down', '0.015': 'down', '0.025': 'down', '0.040': 'down', '0.065': 'down', '0.10': 'down', '0.15': 0, '0.25': 'down', '0.40': 'down', '0.65': 1, '1.0': 2, '1.5': 3, '2.5': 5, '4.0': 8, '6.5': 12, '10': 18, '15': 'up', '25': 'up', '40': 'up', '65': 'up', '100': 'up', '150': 'up', '250': 'up', '400': 'up', '650': 'up', '1000': 'up' },
				'L': { '0.010': 'down', '0.015': 'down', '0.025': 'down', '0.040': 'down', '0.065': 'down', '0.10': 0, '0.15': 'down', '0.25': 'down', '0.40': 1, '0.65': 2, '1.0': 3, '1.5': 5, '2.5': 8, '4.0': 12, '6.5': 18, '10': 'up', '15': 'up', '25': 'up', '40': 'up', '65': 'up', '100': 'up', '150': 'up', '250': 'up', '400': 'up', '650': 'up', '1000': 'up' },
				'M': { '0.010': 'down', '0.015': 'down', '0.025': 'down', '0.040': 'down', '0.065': 0, '0.10': 'down', '0.15': 'down', '0.25': 1, '0.40': 2, '0.65': 3, '1.0': 5, '1.5': 8, '2.5': 12, '4.0': 18, '6.5': 'up', '10': 'up', '15': 'up', '25': 'up', '40': 'up', '65': 'up', '100': 'up', '150': 'up', '250': 'up', '400': 'up', '650': 'up', '1000': 'up' },
				'N': { '0.010': 'down', '0.015': 'down', '0.025': 'down', '0.040': 0, '0.065': 'down', '0.10': 'down', '0.15': 1, '0.25': 2, '0.40': 3, '0.65': 5, '1.0': 8, '1.5': 12, '2.5': 18, '4.0': 'up', '6.5': 'up', '10': 'up', '15': 'up', '25': 'up', '40': 'up', '65': 'up', '100': 'up', '150': 'up', '250': 'up', '400': 'up', '650': 'up', '1000': 'up' },
				'P': { '0.010': 'down', '0.015': 'down', '0.025': 0, '0.040': 'down', '0.065': 'down', '0.10': 1, '0.15': 2, '0.25': 3, '0.40': 5, '0.65': 8, '1.0': 12, '1.5': 18, '2.5': 'up', '4.0': 'up', '6.5': 'up', '10': 'up', '15': 'up', '25': 'up', '40': 'up', '65': 'up', '100': 'up', '150': 'up', '250': 'up', '400': 'up', '650': 'up', '1000': 'up' },
				'Q': { '0.010': 'down', '0.015': 0, '0.025': 'down', '0.040': 'down', '0.065': 1, '0.10': 2, '0.15': 3, '0.25': 5, '0.40': 8, '0.65': 12, '1.0': 18, '1.5': 'up', '2.5': 'up', '4.0': 'up', '6.5': 'up', '10': 'up', '15': 'up', '25': 'up', '40': 'up', '65': 'up', '100': 'up', '150': 'up', '250': 'up', '400': 'up', '650': 'up', '1000': 'up' },
				'R': { '0.010': 0, '0.015': 'up', '0.025': 'down', '0.040': 1, '0.065': 2, '0.10': 3, '0.15': 5, '0.25': 8, '0.40': 12, '0.65': 18, '1.0': 'up', '1.5': 'up', '2.5': 'up', '4.0': 'up', '6.5': 'up', '10': 'up', '15': 'up', '25': 'up', '40': 'up', '65': 'up', '100': 'up', '150': 'up', '250': 'up', '400': 'up', '650': 'up', '1000': 'up' }
			};

            // Reduced Inspection Data

            const codeLettersOrder_reduced = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'J', 'K', 'L', 'M', 'N', 'P', 'Q', 'R'];

            const reduced_sampleSizes = {'A': 2, 'B': 2, 'C': 2, 'D': 3, 'E': 5, 'F': 8, 'G': 13, 'H': 20, 'J': 32, 'K': 50, 'L': 80, 'M': 125, 'N': 200, 'P': 315, 'Q': 500, 'R': 800};

            const reduced_rawMasterTableData = {
                'A': { '0.010': 'down', '0.015': 'down', '0.025': 'down', '0.040': 'down', '0.065': 'down', '0.10': 'down', '0.15': 'down', '0.25': 'down', '0.40': 'down', '0.65': 'down', '1.0': 'down', '1.5': 'down', '2.5': 'down', '4.0': 'down', '6.5': 0     , '10': 'down', '15': 'down', '25': 1   , '40': 2   , '65': 3   , '100': 5   , '150': 7   , '250': 10  , '400': 14  , '650': 21  , '1000': 30   },
                'B': { '0.010': 'down', '0.015': 'down', '0.025': 'down', '0.040': 'down', '0.065': 'down', '0.10': 'down', '0.15': 'down', '0.25': 'down', '0.40': 'down', '0.65': 'down', '1.0': 'down', '1.5': 'down', '2.5': 'down', '4.0': 0     , '6.5': 'up'  , '10': 'down', '15': 0     , '25': 1   , '40': 2   , '65': 3   , '100': 5   , '150': 7   , '250': 10  , '400': 14  , '650': 21  , '1000': 30   },
                'C': { '0.010': 'down', '0.015': 'down', '0.025': 'down', '0.040': 'down', '0.065': 'down', '0.10': 'down', '0.15': 'down', '0.25': 'down', '0.40': 'down', '0.65': 'down', '1.0': 'down', '1.5': 'down', '2.5': 0     , '4.0': 'up'  , '6.5': 'down', '10': 0     , '15': 1     , '25': 1   , '40': 2   , '65': 3   , '100': 5   , '150': 7   , '250': 10  , '400': 14  , '650': 21  , '1000': 'up' },
                'D': { '0.010': 'down', '0.015': 'down', '0.025': 'down', '0.040': 'down', '0.065': 'down', '0.10': 'down', '0.15': 'down', '0.25': 'down', '0.40': 'down', '0.65': 'down', '1.0': 'down', '1.5': 0     , '2.5': 'up'  , '4.0': 'down', '6.5': 0     , '10': 1     , '15': 1     , '25': 2   , '40': 3   , '65': 5   , '100': 7   , '150': 10  , '250': 14  , '400': 21  , '650': 'up', '1000': 'up' },
                'E': { '0.010': 'down', '0.015': 'down', '0.025': 'down', '0.040': 'down', '0.065': 'down', '0.10': 'down', '0.15': 'down', '0.25': 'down', '0.40': 'down', '0.65': 'down', '1.0': 0     , '1.5': 'up'  , '2.5': 'down', '4.0': 0     , '6.5': 1     , '10': 1     , '15': 2     , '25': 3   , '40': 5   , '65': 7   , '100': 10  , '150': 14  , '250': 21  , '400': 'up', '650': 'up', '1000': 'up' },
                'F': { '0.010': 'down', '0.015': 'down', '0.025': 'down', '0.040': 'down', '0.065': 'down', '0.10': 'down', '0.15': 'down', '0.25': 'down', '0.40': 'down', '0.65': 0     , '1.0': 'up'  , '1.5': 'down', '2.5': 0     , '4.0': 1     , '6.5': 1     , '10': 2     , '15': 3     , '25': 5   , '40': 7   , '65': 10  , '100': 'up', '150': 'up', '250': 'up', '400': 'up', '650': 'up', '1000': 'up' },
                'G': { '0.010': 'down', '0.015': 'down', '0.015': 'down', '0.040': 'down', '0.065': 'down', '0.10': 'down', '0.15': 'down', '0.25': 'down', '0.40': 0     , '0.65': 'up'  , '1.0': 'down', '1.5': 0     , '2.5': 1     , '4.0': 1     , '6.5': 2     , '10': 3     , '15': 5     , '25': 7   , '40': 10  , '65': 'up', '100': 'up', '150': 'up', '250': 'up', '400': 'up', '650': 'up', '1000': 'up' },
                'H': { '0.010': 'down', '0.015': 'down', '0.025': 'down', '0.040': 'down', '0.065': 'down', '0.10': 'down', '0.15': 'down', '0.25': 0     , '0.40': 'up'  , '0.65': 'down', '1.0': 1     , '1.5': 1     , '2.5': 1     , '4.0': 2     , '6.5': 3     , '10': 5     , '15': 7     , '25': 10  , '40': 'up', '65': 'up', '100': 'up', '150': 'up', '250': 'up', '400': 'up', '650': 'up', '1000': 'up' },
                'J': { '0.010': 'down', '0.015': 'down', '0.025': 'down', '0.040': 'down', '0.065': 'down', '0.10': 'down', '0.15': 0     , '0.25': 'up'  , '0.40': 'down', '0.65': 0     , '1.0': 1     , '1.5': 1     , '2.5': 2     , '4.0': 3     , '6.5': 5     , '10': 7     , '15': 10    , '25': 'up', '40': 'up', '65': 'up', '100': 'up', '150': 'up', '250': 'up', '400': 'up', '650': 'up', '1000': 'up' },
                'K': { '0.010': 'down', '0.015': 'down', '0.025': 'down', '0.040': 'down', '0.065': 'down', '0.10': 0     , '0.15': 'up'  , '0.25': 'down', '0.40': 0     , '0.65': 1     , '1.0': 2     , '1.5': 2     , '2.5': 3     , '4.0': 5     , '6.5': 7     , '10': 10    , '15': 'up'  , '25': 'up', '40': 'up', '65': 'up', '100': 'up', '150': 'up', '250': 'up', '400': 'up', '650': 'up', '1000': 'up' },
                'L': { '0.010': 'down', '0.015': 'down', '0.025': 'down', '0.040': 'down', '0.065': 0     , '0.10': 'up'  , '0.15': 'down', '0.25': 0     , '0.40': 1     , '0.65': 1     , '1.0': 3     , '1.5': 3     , '2.5': 5     , '4.0': 7     , '6.5': 10    , '10': 'up'  , '15': 'up'  , '25': 'up', '40': 'up', '65': 'up', '100': 'up', '150': 'up', '250': 'up', '400': 'up', '650': 'up', '1000': 'up' },
                'M': { '0.010': 'down', '0.015': 'down', '0.025': 'down', '0.040': 0     , '0.065': 'up'  , '0.10': 'down', '0.15': 0     , '0.25': 1     , '0.40': 1     , '0.65': 2     , '1.0': 5     , '1.5': 5     , '2.5': 7     , '4.0': 10    , '6.5': 'up'  , '10': 'up'  , '15': 'up'  , '25': 'up', '40': 'up', '65': 'up', '100': 'up', '150': 'up', '250': 'up', '400': 'up', '650': 'up', '1000': 'up' },
                'N': { '0.010': 'down', '0.015': 'down', '0.025': 0     , '0.040': 'up'  , '0.065': 'down', '0.10': 0     , '0.15': 1     , '0.25': 1     , '0.40': 2     , '0.65': 3     , '1.0': 8     , '1.5': 7     , '2.5': 10    , '4.0': 'up'  , '6.5': 'up'  , '10': 'up'  , '15': 'up'  , '25': 'up', '40': 'up', '65': 'up', '100': 'up', '150': 'up', '250': 'up', '400': 'up', '650': 'up', '1000': 'up' },
                'P': { '0.010': 'down', '0.015': 0     , '0.025': 'up'  , '0.040': 'down', '0.065': 0     , '0.10': 1     , '0.15': 1     , '0.25': 2     , '0.40': 3     , '0.65': 5     , '1.0': 8     , '1.5': 10    , '2.5': 'up'  , '4.0': 'up'  , '6.5': 'up'  , '10': 'up'  , '15': 'up'  , '25': 'up', '40': 'up', '65': 'up', '100': 'up', '150': 'up', '250': 'up', '400': 'up', '650': 'up', '1000': 'up' },
                'Q': { '0.010': 0     , '0.015': 'up'  , '0.025': 'down', '0.040': 0     , '0.065': 1     , '0.10': 1     , '0.15': 2     , '0.25': 3     , '0.40': 5     , '0.65': 7     , '1.0': 18    , '1.5': 'up'  , '2.5': 'up'  , '4.0': 'up'  , '6.5': 'up'  , '10': 'up'  , '15': 'up'  , '25': 'up', '40': 'up', '65': 'up', '100': 'up', '150': 'up', '250': 'up', '400': 'up', '650': 'up', '1000': 'up' },
                'R': { '0.010': 'up'  , '0.015': 'up'  , '0.025': 0     , '0.040': 1     , '0.065': 1     , '0.10': 2     , '0.15': 3     , '0.25': 5     , '0.40': 7     , '0.65': 10    , '1.0': 'up'  , '1.5': 'up'  , '2.5': 'up'  , '4.0': 'up'  , '6.5': 'up'  , '10': 'up'  , '15': 'up'  , '25': 'up', '40': 'up', '65': 'up', '100': 'up', '150': 'up', '250': 'up', '400': 'up', '650': 'up', '1000': 'up' }
            };
          
            // 狀態變數 (動態指標)
            let rawMasterTableDataRef = normal_rawMasterTableData;
            let sampleSizesRef = normal_sampleSizes;
            let codeLettersOrderRef = codeLettersOrder_normal;
            const masterTable = {};

            function formatNumber(num) {
                if (num === null || num === undefined || isNaN(Number(num))) return num;
                return Number(num).toLocaleString('en-US');
            }

            function findFinalPlan(initialLetter, aql) {
                let currentIndex = codeLettersOrderRef.indexOf(initialLetter);
                if (currentIndex === -1) return { finalLetter: null, finalAc: 'N/A' };
                let currentLetter = initialLetter;
                let plan = rawMasterTableDataRef[currentLetter]?.[aql];
                let visited = new Set([currentLetter]);
                while ((plan === 'down' || plan === 'up')) {
                    currentIndex += (plan === 'down' ? 1 : -1);
                    if (currentIndex < 0 || currentIndex >= codeLettersOrderRef.length) {
                        return { finalLetter: null, finalAc: 'N/A' };
                    }
                    currentLetter = codeLettersOrderRef[currentIndex];
                    if (visited.has(currentLetter)) {
                        return { finalLetter: null, finalAc: 'N/A' };
                    }
                    visited.add(currentLetter);
                    plan = rawMasterTableDataRef[currentLetter]?.[aql];
                }
                const finalAc = typeof plan === 'number' ? plan : 'N/A';
                return { finalLetter: currentLetter, finalAc: finalAc };
            }

            function processMasterTable() {
                for (const letter of codeLettersOrderRef) {
                    masterTable[letter] = {};
                    for (const aql of aqlLevels) {
                        masterTable[letter][aql] = findFinalPlan(letter, aql);
                    }
                }
            }
                
            function switchInspectionType(type) {
                const titleElement = document.querySelector('#aql-lookup-tool h1');
                if (type === 'tightened') {
                    rawMasterTableDataRef = tightened_rawMasterTableData;
                    sampleSizesRef = tightened_sampleSizes;
                    codeLettersOrderRef = codeLettersOrder_tightened;
                    if(titleElement) titleElement.textContent = 'Tightened Single Sampling Plan Lookup Tool';
                } else if (type === 'reduced') {
                    rawMasterTableDataRef = reduced_rawMasterTableData;
                    sampleSizesRef = reduced_sampleSizes;
                    codeLettersOrderRef = codeLettersOrder_reduced;
                    if(titleElement) titleElement.textContent = 'Reduced Single Sampling Plan Lookup Tool';
                } else { // 預設為 Normal
                    rawMasterTableDataRef = normal_rawMasterTableData;
                    sampleSizesRef = normal_sampleSizes;
                    codeLettersOrderRef = codeLettersOrder_normal;
                    if(titleElement) titleElement.textContent = 'Normal Single Sampling Plan Lookup Tool';
                }
                processMasterTable();
                // 僅當舊 aql-lookup-tool 存在時才觸發舊查詢，避免空值錯誤
                if (document.getElementById('lot-size-select') && document.getElementById('aql-select')) {
                    performQuery();
                }
            }

            function initializeSelects() {
                const lotSizeSelect = document.getElementById('lot-size-select');
                const aqlSelect = document.getElementById('aql-select');
                if (!lotSizeSelect || !aqlSelect) return; // 當舊 aql-lookup-tool 不存在時直接跳過
                lotSizeSelect.innerHTML = '<option value="">-- Select Lot Size --</option>';
                codeLetterTable.forEach((range, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    let text = `${formatNumber(range.min)} - ${formatNumber(range.max)}`;
                    if (range.max === null) text = `${formatNumber(range.min)} and over`;
                    option.textContent = text;
                    lotSizeSelect.appendChild(option);
                });
                aqlSelect.innerHTML = '<option value="">-- Select AQL --</option>';
                aqlLevels.forEach(aql => {
                    const option = document.createElement('option');
                    option.value = aql;
                    option.textContent = aql;
                    aqlSelect.appendChild(option);
                });
            }

            function performQuery() {
                const lotSizeSelect = document.getElementById('lot-size-select');
                const levelSelect = document.getElementById('level-select');
                const aqlSelect = document.getElementById('aql-select');
                const resultContainer = document.getElementById('result-container');
                const sampleSizeSpan = document.getElementById('sample-size-result');
                const acceptanceNumberSpan = document.getElementById('acceptance-number-result');
                const originalCodeLetterSpan = document.getElementById('original-code-letter');
                    
                const rangeIndex = lotSizeSelect.value;
                const level = levelSelect.value;
                const aql = aqlSelect.value;

                if (rangeIndex === "" || !level || aql === "") {
                    resultContainer.style.display = 'none';
                    return;
                }

                const initialCodeLetter = codeLetterTable[rangeIndex].levels[level];
                if (!initialCodeLetter) {
                    resultContainer.style.display = 'none';
                    return;
                }

                const finalPlan = masterTable[initialCodeLetter]?.[aql];
                if (!finalPlan || !finalPlan.finalLetter) {
                    resultContainer.style.display = 'none';
                    return;
                }
                    
                const { finalLetter, finalAc } = finalPlan;
                const finalSampleSize = sampleSizesRef[finalLetter] || 'N/A'; // 使用動態參考
                sampleSizeSpan.textContent = formatNumber(finalSampleSize);
                acceptanceNumberSpan.textContent = finalAc;

                // [新增] 全檢提示訊息（僅顯示，不更動資料表）
                let fullInspectionMsg = document.getElementById('full-inspection-msg');
                if (!fullInspectionMsg) {
                    fullInspectionMsg = document.createElement('div');
                    fullInspectionMsg.id = 'full-inspection-msg';
                    fullInspectionMsg.style.color = '#e74c3c';
                    fullInspectionMsg.style.fontWeight = 'bold';
                    fullInspectionMsg.style.marginTop = '18px';
                    fullInspectionMsg.style.fontSize = '1.15em';
                    resultContainer.appendChild(fullInspectionMsg);
                } else {
                    resultContainer.appendChild(fullInspectionMsg);
                }
                const N1 = codeLetterTable[rangeIndex].min;
                // 只根據顯示結果判斷，不更動任何資料表
                if (typeof finalSampleSize === 'number' && finalSampleSize > N1) {
                    fullInspectionMsg.textContent = 'If the sample size (n) is greater than the lot size (N), 100% inspection is required.';
                    fullInspectionMsg.style.display = 'block';
                } else {
                    fullInspectionMsg.textContent = '';
                    fullInspectionMsg.style.display = 'none';
                }

                if (finalAc === 'N/A') {
                    resultContainer.classList.add('error');
                    acceptanceNumberSpan.textContent = "N/A";
                } else {
                    resultContainer.classList.remove('error');
                }

                if (initialCodeLetter !== finalLetter) {
                    originalCodeLetterSpan.textContent = `(Code letter changed from ${initialCodeLetter} to ${finalLetter})`;
                } else {
                    originalCodeLetterSpan.textContent = `(Code letter: ${initialCodeLetter})`;
                }
                    
                resultContainer.style.display = 'block';
                const exportBtn = document.getElementById('aql-export-to-plan-btn');
                if (exportBtn) exportBtn.disabled = finalAc === 'N/A';
            }

                // --- 初始化與事件監聽 ---
            initializeSelects();
            processMasterTable();

                // 綁定按鈕
                const inspectionTypeBtns = document.querySelectorAll('#sampling-standard-controls .inspection-type-btn');
                inspectionTypeBtns.forEach(btn => {
                    btn.addEventListener('click', function() {
                        inspectionTypeBtns.forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        switchInspectionType(this.getAttribute('data-type'));
                        // 切換 Normal/Tightened/Reduced 後，保持現有選值並即時重繪
                        performSSQuery(true);
                    });
                });
                
                // 綁定下拉選單
            const lotSizeSelect = document.getElementById('lot-size-select');
            const levelSelect = document.getElementById('level-select');
            const aqlSelect = document.getElementById('aql-select');
            if (lotSizeSelect) lotSizeSelect.addEventListener('change', performQuery);
            if (levelSelect) levelSelect.addEventListener('change', performQuery);
            if (aqlSelect) aqlSelect.addEventListener('change', performQuery);

                // 為"匯出"按鈕添加功能
                const exportBtn = document.getElementById('aql-export-to-plan-btn');
                if (exportBtn) {
                    exportBtn.onclick = function() {
                        const nText = document.getElementById('sample-size-result').textContent.replace(/,/g, '');
                        const cText = document.getElementById('acceptance-number-result').textContent;
                        const aqlText = document.getElementById('aql-select').value;
                        const xAxisMax = 2; // 預設值

                        const n = parseInt(nText);
                        const c = (cText === 'N/A') ? null : parseInt(cText);

                        if (isNaN(n) || n <= 0 || c === null || isNaN(c)) {
                            alert('Unable to export result. Please query a valid plan first.');
                            return;
                        }

                        document.getElementById('plan_n_input').value = n;
                        document.getElementById('plan_c_input').value = c;
                        document.getElementById('plan_aql_input').value = aqlText;
                        document.getElementById('plan_x_axis_max_input').value = xAxisMax;

                        document.getElementById('mode-plan').checked = true;
                        if (typeof switchMode === 'function') switchMode('plan');
                    };
                }

                // === Sampling Standard (ss-*) 選單初始化與查詢 ===
                function initializeSSSelects() {
                    const lotSizeSelect = document.getElementById('ss-lot-size-select');
                    const aqlSelect = document.getElementById('ss-aql-select');
                    if (!lotSizeSelect || !aqlSelect) return;
                    lotSizeSelect.innerHTML = '<option value="">-- Select Lot Size --</option>';
                    codeLetterTable.forEach((range, index) => {
                        const option = document.createElement('option');
                        option.value = index;
                        let text = `${formatNumber(range.min)} - ${formatNumber(range.max)}`;
                        if (range.max === null) text = `${formatNumber(range.min)} and over`;
                        option.textContent = text;
                        lotSizeSelect.appendChild(option);
                    });
                    aqlSelect.innerHTML = '<option value="">-- Select AQL --</option>';
                    aqlLevels.forEach(aql => {
                        const option = document.createElement('option');
                        option.value = aql;
                        option.textContent = aql;
                        aqlSelect.appendChild(option);
                    });
                }

                function updateSamplingStandardChart(n, c) {
                    if (!ocChart) return;
                    const xAxisMaxInput = document.getElementById('ss_x_axis_max_input');
                    const xAxisMaxPercent = (!xAxisMaxInput || xAxisMaxInput.value === '') ? 3 : parseFloat(xAxisMaxInput.value);
                    ocChart.options.scales.x.max = xAxisMaxPercent;
                    const pValues = typeof generatePValues === 'function' ? generatePValues(xAxisMaxPercent) : [];
                    const dataPoints = typeof getOCData === 'function' ? getOCData({ n, c }, pValues) : [];
                    ocChart.data.datasets = [
                        { label: `OC Curve (n=${n}, c=${c})`, data: dataPoints, borderColor: 'rgba(46,204,113,0.95)', backgroundColor: 'rgba(46,204,113,0.25)', borderWidth: 3, pointRadius: 0, tension: 0.1 }
                    ];
                    if (ocChart.options && ocChart.options.plugins && ocChart.options.plugins.title) {
                        ocChart.options.plugins.title.text = 'Sampling Standard OC Curve';
                    }
                    ocChart.update();
                }

                function performSSQuery(skipScroll) {
                    const lotSizeSelect = document.getElementById('ss-lot-size-select');
                    const levelSelect = document.getElementById('ss-level-select');
                    const aqlSelect = document.getElementById('ss-aql-select');
                    const resultContainer = document.getElementById('ss-result-container');
                    const sampleSizeSpan = document.getElementById('ss-sample-size-result');
                    const acceptanceNumberSpan = document.getElementById('ss-acceptance-number-result');
                    const originalCodeLetterSpan = document.getElementById('ss-original-code-letter');
                    const errorBox = document.getElementById('ss-error');
                    if (!lotSizeSelect || !levelSelect || !aqlSelect) return;

                    const rangeIndex = lotSizeSelect.value;
                    const level = levelSelect.value;
                    const aql = aqlSelect.value;

                    errorBox.textContent = '';
                    if (rangeIndex === '' || !level || aql === '') {
                        if (resultContainer) resultContainer.style.display = 'none';
                        return;
                    }
                    const initialCodeLetter = codeLetterTable[rangeIndex]?.levels?.[level];
                    if (!initialCodeLetter) {
                        if (resultContainer) resultContainer.style.display = 'none';
                        return;
                    }
                    const finalPlan = masterTable[initialCodeLetter]?.[aql];
                    if (!finalPlan || !finalPlan.finalLetter) {
                        if (resultContainer) resultContainer.style.display = 'none';
                        errorBox.textContent = 'No valid plan for the selected inputs.';
                        return;
                    }
                    const { finalLetter, finalAc } = finalPlan;
                    const finalSampleSize = sampleSizesRef[finalLetter] || 'N/A';
                    if (sampleSizeSpan) sampleSizeSpan.textContent = formatNumber(finalSampleSize);
                    if (acceptanceNumberSpan) acceptanceNumberSpan.textContent = finalAc;
                    if (originalCodeLetterSpan) {
                        if (initialCodeLetter !== finalLetter) {
                            originalCodeLetterSpan.textContent = `(Code letter changed from ${initialCodeLetter} to ${finalLetter})`;
                        } else {
                            originalCodeLetterSpan.textContent = `(Code letter: ${initialCodeLetter})`;
                        }
                    }
                    if (resultContainer) resultContainer.style.display = 'block';

                    // 繪製圖表（寬鬆數值檢查，確保能刷新）
                    const nNum = Number(finalSampleSize);
                    const cNum = Number(finalAc);
                    if (Number.isFinite(nNum) && Number.isFinite(cNum)) {
                        updateSamplingStandardChart(nNum, cNum);
                    }
                }

                // 綁定 ss-* 控制項
                initializeSSSelects();
                const ssLot = document.getElementById('ss-lot-size-select');
                const ssLvl = document.getElementById('ss-level-select');
                const ssAql = document.getElementById('ss-aql-select');
                const ssXAxis = document.getElementById('ss_x_axis_max_input');
                if (ssLot) ssLot.addEventListener('change', () => performSSQuery());
                if (ssLvl) ssLvl.addEventListener('change', () => performSSQuery());
                if (ssAql) ssAql.addEventListener('change', () => performSSQuery());
                if (ssXAxis) ssXAxis.addEventListener('input', () => performSSQuery());
                const ssExportBtn = document.getElementById('ss-export-to-plan-btn');
                if (ssExportBtn) {
                    ssExportBtn.addEventListener('click', function() {
                        const nText = document.getElementById('ss-sample-size-result')?.textContent?.replace(/,/g, '') || '';
                        const cText = document.getElementById('ss-acceptance-number-result')?.textContent || '';
                        const aqlText = document.getElementById('ss-aql-select')?.value || '';
                        const xAxisMax = document.getElementById('plan_x_axis_max_input')?.value || 2;
                        const n = parseInt(nText);
                        const c = (cText === 'N/A') ? null : parseInt(cText);
                        if (isNaN(n) || n <= 0 || c === null || isNaN(c)) {
                            alert('Unable to export result. Please query a valid plan first.');
                            return;
                        }
                        document.getElementById('plan_n_input').value = n;
                        document.getElementById('plan_c_input').value = c;
                        document.getElementById('plan_aql_input').value = aqlText;
                        document.getElementById('plan_x_axis_max_input').value = xAxisMax;
                        document.getElementById('mode-plan').checked = true;
                        if (typeof switchMode === 'function') switchMode('plan');
                    });
                }
            })();

            // === 抽樣計畫原理說明彈窗 ===
            const samplingTheoryBtn = document.getElementById('sampling-theory-btn');
            const samplingTheoryModalBg = document.getElementById('sampling-theory-modal-bg');
            const samplingTheoryModal = document.getElementById('sampling-theory-modal');
            const samplingTheoryCloseBtn = samplingTheoryModal ? samplingTheoryModal.querySelector('.close-btn') : null;
            if (samplingTheoryBtn && samplingTheoryModalBg) {
                samplingTheoryBtn.addEventListener('click', function() {
                    samplingTheoryModalBg.style.display = 'flex';
                });
            }
            if (samplingTheoryCloseBtn && samplingTheoryModalBg) {
                samplingTheoryCloseBtn.addEventListener('click', function() {
                    samplingTheoryModalBg.style.display = 'none';
                });
                samplingTheoryModalBg.addEventListener('click', function(e) {
                    if (e.target === samplingTheoryModalBg) samplingTheoryModalBg.style.display = 'none';
                });
            }
           
        });

        // [C=0 Table Image] 直接貼上你的 base64 字串
        const c0TableBase64 = ""; // <--- 請將你的 base64 字串貼在這裡（格式如：data:image/png;base64,xxxx）

        const showC0TableBtn = document.getElementById('show-c0-table-btn');
        const c0TableImage = document.getElementById('c0-table-image');
        const c0TableModalBg = document.getElementById('c0-table-modal-bg');
        const c0TableModal = document.getElementById('c0-table-modal');
        const c0TableModalCloseBtn = c0TableModal ? c0TableModal.querySelector('.close-btn') : null;
        if (showC0TableBtn && c0TableImage && c0TableModalBg) {
            showC0TableBtn.addEventListener('click', function() {
                c0TableImage.src = c0TableBase64;
                c0TableModalBg.style.display = 'flex';
            });
        }
        if (c0TableModalCloseBtn && c0TableModalBg) {
            c0TableModalCloseBtn.addEventListener('click', function() {
                c0TableModalBg.style.display = 'none';
            });
            c0TableModalBg.addEventListener('click', function(e) {
                if (e.target === c0TableModalBg) c0TableModalBg.style.display = 'none';
            });
        }
    </script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        var img = document.getElementById('c0-table-image');
        var title = document.getElementById('c0-table-title');
        function centerTitle() {
            if (img && title) {
                title.textContent = 'C=0 Sampling Table';
                title.style.width = img.clientWidth + 'px';
            }
        }
        img.onload = centerTitle;
        // 若圖片已載入也要處理
        if (img.complete) centerTitle();
    });
    </script>
</body>
</html>
